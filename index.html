
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pengelolaan Hafalan & Ibadah Santri</title>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #10B981; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #059669; }

        .dark { background: linear-gradient(135deg, #1a202c 0%, #2d3748 50%, #4a5568 100%); }
        .dark .bg-white { background-color: #2d3748 !important; }
        .dark .bg-gray-50 { background-color: #374151 !important; }
        .dark .text-gray-900 { color: #f7fafc !important; }
        .dark .text-gray-600 { color: #cbd5e0 !important; }
        .dark .border-gray-200 { border-color: #4a5568 !important; }

        .angkatan-8 { background: linear-gradient(135deg, #10B981, #059669); }
        .angkatan-9 { background: linear-gradient(135deg, #3B82F6, #1E40AF); }
        .angkatan-10 { background: linear-gradient(135deg, #8B5CF6, #7C3AED); }
        .angkatan-11 { background: linear-gradient(135deg, #F59E0B, #D97706); }
        .angkatan-12 { background: linear-gradient(135deg, #10B981, #059669); }
        .angkatan-13 { background: linear-gradient(135deg, #3B82F6, #1E40AF); }
        .angkatan-14 { background: linear-gradient(135deg, #8B5CF6, #7C3AED); }
        .angkatan-15 { background: linear-gradient(135deg, #F59E0B, #D97706); }

        @media print { .no-print { display: none !important; } }
        
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        .slide-enter-active, .slide-leave-active { transition: transform 0.3s ease; }
        .slide-enter-from { transform: translateY(-10px); }
        .slide-leave-to { transform: translateY(10px); }

        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }

        .tahfizh-progress {
            background: linear-gradient(90deg, #10B981 0%, #34D399 50%, #6EE7B7 100%);
        }

        .ibadah-complete {
            background: linear-gradient(135deg, #10B981, #059669);
        }

        .ibadah-incomplete {
            background: linear-gradient(135deg, #EF4444, #DC2626);
        }

        .spreadsheet-container {
            max-height: 70vh;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }

        .spreadsheet-header {
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
            border-bottom: 2px solid #e5e7eb;
        }

        .dark .spreadsheet-header {
            background: #374151;
            border-bottom-color: #4a5568;
        }

        .spreadsheet-cell {
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
            padding: 8px;
            text-align: center;
            min-width: 60px;
        }

        .dark .spreadsheet-cell {
            border-color: #4a5568;
        }

        .santri-name-cell {
            position: sticky;
            left: 0;
            background: white;
            z-index: 5;
            min-width: 150px;
            text-align: left;
        }

        .dark .santri-name-cell {
            background: #374151;
        }

        .ibadah-checkbox {
            transform: scale(1.2);
            cursor: pointer;
        }

        .juz-indicator {
            font-size: 0.75rem;
            color: #059669;
            margin-top: 2px;
            font-weight: 600;
        }

        .dark .juz-indicator {
            color: #10b981;
        }

        .attendance-select {
            font-size: 0.75rem;
            padding: 2px 4px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
            background: white;
        }

        .dark .attendance-select {
            background: #374151;
            border-color: #4a5568;
            color: white;
        }

        .attendance-hadir { background-color: #10b981 !important; color: white; }
        .attendance-izin { background-color: #f59e0b !important; color: white; }
        .attendance-sakit { background-color: #ef4444 !important; color: white; }
        .attendance-tanpa_keterangan { background-color: #6b7280 !important; color: white; }

        .halaqah-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .halaqah-item {
            text-align: center;
            font-size: 0.75rem;
        }

        .attendance-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .stat-item {
            text-align: center;
            padding: 4px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .progress-indicator {
            background: #f3f4f6;
            border-radius: 8px;
            padding: 8px;
            margin-top: 8px;
        }

        .dark .progress-indicator {
            background: #374151;
        }

        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .status-connected {
            background: #10b981;
            color: white;
        }

        .status-disconnected {
            background: #ef4444;
            color: white;
        }

        .status-connecting {
            background: #f59e0b;
            color: white;
        }
    </style>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#ecfdf5', 500: '#10B981', 600: '#059669', 700: '#047857' },
                        emerald: { 50: '#ecfdf5', 500: '#10B981', 600: '#059669' }
                    }
                }
            }
        }
    </script>
</head>

<body class="min-h-screen transition-colors duration-200" id="app">
    <!-- Connection Status Indicator -->
    <div v-if="!loading" 
         :class="connectionStatusClass"
         class="connection-status">
        <i :class="connectionStatusIcon" class="mr-2"></i>
        {{ connectionStatusText }}
    </div>

    <!-- Loading Screen -->
    <div v-if="loading" class="fixed inset-0 bg-gradient-to-br from-emerald-500 to-green-600 flex items-center justify-center z-50">
        <div class="text-center text-white">
            <div class="animate-spin rounded-full h-16 w-16 border-4 border-white border-t-transparent mb-4 mx-auto"></div>
            <h2 class="text-2xl font-bold mb-2">Mutabaah Santri Ibnu Katsir</h2>
            <p class="text-lg opacity-90">Bismillahirrahmanirrahim...</p>
            <div v-if="connectionStatus === 'connecting'" class="mt-4">
                <p class="text-sm opacity-75">Menghubungkan ke database...</p>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <transition-group name="slide" tag="div" class="fixed top-4 right-4 z-40 space-y-2">
        <div v-for="notification in notifications" 
             :key="notification.id"
             class="max-w-sm rounded-lg shadow-lg p-4 pointer-events-auto"
             :class="getNotificationClass(notification.type)">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i :class="getNotificationIcon(notification.type)" class="mr-2"></i>
                    <span>{{ notification.message }}</span>
                </div>
                <button @click="removeNotification(notification.id)" class="ml-2 hover:opacity-75">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </transition-group>

    <!-- Modal for Add/Edit Santri -->
    <div v-if="showSantriModal" 
         class="fixed inset-0 z-50 overflow-y-auto modal-overlay"
         @click.self="closeSantriModal">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-user-graduate mr-2 text-emerald-500"></i>
                                {{ editingSantri ? 'Edit Santri' : 'Tambah Santri Baru' }}
                            </h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Nama Lengkap <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" 
                                           v-model="santriForm.name"
                                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                           placeholder="Masukkan nama lengkap santri">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Angkatan <span class="text-red-500">*</span>
                                    </label>
                                    <input type="number" 
                                           v-model.number="santriForm.angkatan"
                                           min="1" max="50"
                                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                           placeholder="Contoh: 15">
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Masukkan nomor angkatan (contoh: 12, 13, 14, 15)</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Musyrif Pembimbing <span class="text-red-500">*</span>
                                    </label>
                                    <select v-model="santriForm.musyrifId"
                                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option value="">-- Pilih Musyrif --</option>
                                        <option v-for="musyrif in musyrifList" :key="musyrif.id" :value="musyrif.id">
                                            {{ musyrif.name }}
                                        </option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button @click="saveSantri()" 
                            :disabled="isSubmitting || !isSantriFormValid"
                            :class="isSubmitting || !isSantriFormValid ? 'opacity-50 cursor-not-allowed' : 'hover:bg-emerald-700'"
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-emerald-600 text-base font-medium text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 sm:ml-3 sm:w-auto sm:text-sm">
                        <span v-if="!isSubmitting">
                            <i class="fas fa-save mr-2"></i>
                            {{ editingSantri ? 'Update' : 'Simpan' }}
                        </span>
                        <span v-else class="flex items-center">
                            <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"></div>
                            {{ editingSantri ? 'Mengupdate...' : 'Menyimpan...' }}
                        </span>
                    </button>
                    
                    <button @click="closeSantriModal()" 
                            type="button"
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        <i class="fas fa-times mr-2"></i>Batal
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Add/Edit Musyrif -->
    <div v-if="showMusyrifModal" 
         class="fixed inset-0 z-50 overflow-y-auto modal-overlay"
         @click.self="closeMusyrifModal">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-chalkboard-teacher mr-2 text-emerald-500"></i>
                                {{ editingMusyrif ? 'Edit Musyrif' : 'Tambah Musyrif Baru' }}
                            </h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Nama Lengkap <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" 
                                           v-model="musyrifForm.name"
                                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                           placeholder="Masukkan nama lengkap musyrif">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Username <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" 
                                           v-model="musyrifForm.username"
                                           :disabled="editingMusyrif"
                                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white disabled:opacity-50"
                                           placeholder="Masukkan username untuk login">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Password <span class="text-red-500">*</span>
                                    </label>
                                    <input type="password" 
                                           v-model="musyrifForm.password"
                                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                           :placeholder="editingMusyrif ? 'Kosongkan jika tidak ingin mengubah password' : 'Masukkan password'">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button @click="saveMusyrif()" 
                            :disabled="isSubmitting || !isMusyrifFormValid"
                            :class="isSubmitting || !isMusyrifFormValid ? 'opacity-50 cursor-not-allowed' : 'hover:bg-emerald-700'"
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-emerald-600 text-base font-medium text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 sm:ml-3 sm:w-auto sm:text-sm">
                        <span v-if="!isSubmitting">
                            <i class="fas fa-save mr-2"></i>
                            {{ editingMusyrif ? 'Update' : 'Simpan' }}
                        </span>
                        <span v-else class="flex items-center">
                            <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"></div>
                            {{ editingMusyrif ? 'Mengupdate...' : 'Menyimpan...' }}
                        </span>
                    </button>
                    
                    <button @click="closeMusyrifModal()" 
                            type="button"
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        <i class="fas fa-times mr-2"></i>Batal
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration Modal -->
    <div v-if="showConfigModal" 
         class="fixed inset-0 z-50 overflow-y-auto modal-overlay"
         @click.self="closeConfigModal">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-cog mr-2 text-emerald-500"></i>
                                Konfigurasi Database Supabase
                            </h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Supabase URL <span class="text-red-500">*</span>
                                    </label>
                                    <input type="url" 
                                           v-model="dbConfig.supabaseUrl"
                                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                           placeholder="https://xxxxxxxx.supabase.co">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Supabase Anon Key <span class="text-red-500">*</span>
                                    </label>
                                    <textarea v-model="dbConfig.supabaseKey"
                                              rows="4"
                                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                              placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."></textarea>
                                </div>
                                
                                <div class="text-xs text-gray-500 dark:text-gray-400">
                                    <p class="mb-2">Untuk mendapatkan URL dan Key Supabase:</p>
                                    <ol class="list-decimal list-inside space-y-1">
                                        <li>Buka dashboard.supabase.com</li>
                                        <li>Pilih project Anda</li>
                                        <li>Pergi ke Settings → API</li>
                                        <li>Copy URL dan anon public key</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button @click="saveDbConfig()" 
                            :disabled="isConnecting || !dbConfig.supabaseUrl || !dbConfig.supabaseKey"
                            :class="isConnecting || !dbConfig.supabaseUrl || !dbConfig.supabaseKey ? 'opacity-50 cursor-not-allowed' : 'hover:bg-emerald-700'"
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-emerald-600 text-base font-medium text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 sm:ml-3 sm:w-auto sm:text-sm">
                        <span v-if="!isConnecting">
                            <i class="fas fa-save mr-2"></i>Simpan & Koneksi
                        </span>
                        <span v-else class="flex items-center">
                            <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"></div>
                            Menghubungkan...
                        </span>
                    </button>
                    
                    <button @click="closeConfigModal()" 
                            type="button"
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        <i class="fas fa-times mr-2"></i>Batal
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="min-h-screen" 
         :class="{ 'bg-gradient-to-br from-emerald-50 via-green-50 to-blue-50 dark:from-gray-900 dark:via-gray-800 dark:to-gray-700': true, 'dark': darkMode }">
        
        <!-- Login Screen -->
        <div v-if="!isLoggedIn && !isPublicAccess" class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-md">
                <div class="flex justify-between items-center mb-4">
                    <button @click="openConfigModal()" 
                            class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
                            title="Konfigurasi Database">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button @click="toggleDarkMode()" 
                            class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                        <i v-if="!darkMode" class="fas fa-moon"></i>
                        <i v-else class="fas fa-sun"></i>
                    </button>
                </div>

                <div class="text-center mb-8">
                    <div class="mx-auto w-16 h-16 bg-gradient-to-br from-emerald-500 to-green-600 rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-book-quran text-2xl text-white"></i>
                    </div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Mutabaah Tahfizh dan Amal Yaumi</h1>
                    <p class="text-gray-600 dark:text-gray-400">Ibnu Katsir Indonesia</p>
                </div>

                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fas fa-user mr-2"></i>Username
                        </label>
                        <input type="text" 
                               v-model="credentials.username"
                               @keyup.enter="login"
                               class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                               placeholder="Masukkan username">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fas fa-lock mr-2"></i>Password
                        </label>
                        <input type="password" 
                               v-model="credentials.password"
                               @keyup.enter="login"
                               class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                               placeholder="Masukkan password">
                    </div>
                </div>

                <div v-if="loginError" class="mb-4 p-3 bg-red-100 dark:bg-red-900/20 border border-red-300 dark:border-red-700 rounded-lg text-red-700 dark:text-red-300 text-sm">
                    <i class="fas fa-exclamation-circle mr-2"></i>{{ loginError }}
                </div>

                <div class="space-y-3">
                    <button @click="login" 
                            :disabled="!credentials.username || !credentials.password || isLoggingIn"
                            :class="!credentials.username || !credentials.password || isLoggingIn ? 'opacity-50 cursor-not-allowed' : 'hover:shadow-lg'"
                            class="w-full bg-gradient-to-r from-emerald-500 to-green-600 text-white py-3 px-6 rounded-xl font-semibold transition-all duration-200">
                        <span v-if="!isLoggingIn">
                            <i class="fas fa-sign-in-alt mr-2"></i>Masuk
                        </span>
                        <span v-else class="flex items-center justify-center">
                            <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"></div>
                            Masuk...
                        </span>
                    </button>
                    
                    <button @click="accessPublic" 
                            class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 px-6 rounded-xl font-semibold transition-colors">
                        <i class="fas fa-chart-bar mr-2"></i>Lihat Rekap Tahfizh
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Application -->
        <div v-else class="min-h-screen">
            <!-- Header -->
            <div class="bg-gradient-to-r from-emerald-500 to-green-600 shadow-xl">
                <div class="container mx-auto px-4 py-6">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                        <div>
                            <h1 class="text-2xl lg:text-3xl font-bold text-white mb-2">
                                <i class="fas fa-book-quran mr-3"></i>Sistem Pengelolaan Santri
                            </h1>
                            <p class="text-lg text-emerald-100">
                                {{ isPublicAccess ? 'Rekap Tahfizh Public' : 
                                   isAdmin ? 'Panel Administrator' : 
                                   isMusyrif ? `Selamat datang, ${currentUser.name}` : 'Dashboard' }}
                            </p>
                        </div>
                        
                        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                            <div class="flex items-center space-x-2">
                                <button @click="toggleDarkMode()" 
                                        class="p-2 rounded-lg bg-white/20 backdrop-blur-sm hover:bg-white/30 transition-colors text-white">
                                    <i v-if="!darkMode" class="fas fa-moon"></i>
                                    <i v-else class="fas fa-sun"></i>
                                </button>
                                
                                <button v-if="!isPublicAccess" @click="openConfigModal()" 
                                        class="p-2 rounded-lg bg-white/20 backdrop-blur-sm hover:bg-white/30 transition-colors text-white"
                                        title="Konfigurasi Database">
                                    <i class="fas fa-cog"></i>
                                </button>
                            </div>

                            <div v-if="!isPublicAccess" class="flex gap-2">
                                <button v-if="!isPublicAccess" @click="accessPublic" 
                                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors flex items-center space-x-2">
                                    <i class="fas fa-chart-bar"></i>
                                    <span class="hidden sm:inline">Rekap Public</span>
                                </button>
                                
                                <button @click="logout()" 
                                        class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors flex items-center space-x-2">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span class="hidden sm:inline">Logout</span>
                                </button>
                            </div>
                            
                            <div v-else>
                                <button @click="backToLogin" 
                                        class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg font-semibold transition-colors flex items-center space-x-2">
                                    <i class="fas fa-sign-in-alt"></i>
                                    <span>Login</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="container mx-auto px-4 py-6 max-w-7xl">
                <!-- Navigation Tabs (Only when logged in, not public) -->
                <div v-if="!isPublicAccess" class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-2 mb-6">
                    <nav class="flex flex-wrap gap-2">
                        <!-- ADMIN TABS -->
                        <template v-if="isAdmin">
                            <button @click="activeTab = 'admin-dashboard'" 
                                    :class="activeTab === 'admin-dashboard' ? 'bg-emerald-500 text-white shadow-md' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'"
                                    class="px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center space-x-2">
                                <i class="fas fa-tachometer-alt"></i>
                                <span>Dashboard</span>
                            </button>

                            <button @click="activeTab = 'manage-musyrif'" 
                                    :class="activeTab === 'manage-musyrif' ? 'bg-emerald-500 text-white shadow-md' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'"
                                    class="px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center space-x-2">
                                <i class="fas fa-chalkboard-teacher"></i>
                                <span>Kelola Musyrif</span>
                            </button>

                            <button @click="activeTab = 'manage-santri'" 
                                    :class="activeTab === 'manage-santri' ? 'bg-emerald-500 text-white shadow-md' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'"
                                    class="px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center space-x-2">
                                <i class="fas fa-user-graduate"></i>
                                <span>Kelola Santri</span>
                            </button>
                            
                            <button @click="activeTab = 'tahfizh-recap'" 
                                    :class="activeTab === 'tahfizh-recap' ? 'bg-emerald-500 text-white shadow-md' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'"
                                    class="px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center space-x-2">
                                <i class="fas fa-chart-line"></i>
                                <span>Rekap Tahfizh</span>
                            </button>

                            <button @click="activeTab = 'ibadah-recap'" 
                                    :class="activeTab === 'ibadah-recap' ? 'bg-emerald-500 text-white shadow-md' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'"
                                    class="px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center space-x-2">
                                <i class="fas fa-pray"></i>
                                <span>Rekap Ibadah</span>
                            </button>

                            <button @click="activeTab = 'attendance-recap'" 
                                    :class="activeTab === 'attendance-recap' ? 'bg-emerald-500 text-white shadow-md' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'"
                                    class="px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center space-x-2">
                                <i class="fas fa-calendar-check"></i>
                                <span>Rekap Kehadiran</span>
                            </button>
                        </template>
                        
                        <!-- MUSYRIF TABS -->
                        <template v-else-if="isMusyrif">
                            <button @click="activeTab = 'tahfizh-input'" 
                                    :class="activeTab === 'tahfizh-input' ? 'bg-emerald-500 text-white shadow-md' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'"
                                    class="px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center space-x-2">
                                <i class="fas fa-book-open"></i>
                                <span>Input Tahfizh</span>
                            </button>
                            
                            <button @click="activeTab = 'ibadah-input'" 
                                    :class="activeTab === 'ibadah-input' ? 'bg-emerald-500 text-white shadow-md' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'"
                                    class="px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center space-x-2">
                                <i class="fas fa-hands"></i>
                                <span>Ibadah Harian</span>
                            </button>

                            <button @click="activeTab = 'attendance-input'" 
                                    :class="activeTab === 'attendance-input' ? 'bg-emerald-500 text-white shadow-md' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'"
                                    class="px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center space-x-2">
                                <i class="fas fa-user-check"></i>
                                <span>Kehadiran</span>
                            </button>

                            <button @click="activeTab = 'attendance-recap'" 
                                    :class="activeTab === 'attendance-recap' ? 'bg-emerald-500 text-white shadow-md' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'"
                                    class="px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center space-x-2">
                                <i class="fas fa-calendar-check"></i>
                                <span>Rekap Kehadiran</span>
                            </button>
                        </template>
                    </nav>
                </div>

                <!-- Content Area -->
                <div class="space-y-6">
                    <!-- Public/Admin Tahfizh Recap -->
                    <div v-if="isPublicAccess || activeTab === 'tahfizh-recap'">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
                                <i class="fas fa-chart-line mr-3 text-emerald-500"></i>
                                Rekap Progress Tahfizh Santri
                            </h2>

                            <!-- Filter -->
                            <div class="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Filter Bulan</label>
                                    <select v-model="tahfizhFilter.month" 
                                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option v-for="month in getAvailableMonths()" :key="month.value" :value="month.value">
                                            {{ month.label }}
                                        </option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Filter Angkatan</label>
                                    <select v-model="tahfizhFilter.angkatan" 
                                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option value="">Semua Angkatan</option>
                                        <option v-for="angkatan in uniqueAngkatanList" 
                                               :key="`tahfizh-filter-${angkatan}`" 
                                               :value="angkatan">
                                            Angkatan {{ angkatan }}
                                        </option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Filter Musyrif</label>
                                    <select v-model="tahfizhFilter.musyrif" 
                                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option value="">Semua Musyrif</option>
                                        <option v-for="musyrif in musyrifList" :key="musyrif.id" :value="musyrif.id">
                                            {{ musyrif.name }}
                                        </option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Urutkan</label>
                                    <select v-model="tahfizhFilter.sort" 
                                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option value="progress">Progress Tertinggi</option>
                                        <option value="name">Nama (A-Z)</option>
                                        <option value="angkatan">Angkatan</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Progress Cards -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div v-for="santri in filteredSantriForRecap" :key="santri.id" 
                                     class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-700 dark:to-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-600 hover:shadow-lg transition-all duration-200">
                                    <div class="flex items-center justify-between mb-4">
                                        <div>
                                            <h3 class="text-lg font-bold text-gray-900 dark:text-white">{{ santri.name }}</h3>
                                            <div class="flex items-center space-x-2 mt-1">
                                                <span :class="`angkatan-${santri.angkatan}`" class="px-2 py-1 rounded-full text-xs font-medium text-white">
                                                    Angkatan {{ santri.angkatan }}
                                                </span>
                                                <span class="text-sm text-gray-600 dark:text-gray-400">
                                                    {{ getMusyrifName(santri.musyrifId) }}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold text-emerald-600 dark:text-emerald-400">
                                                Juz {{ getSantriCurrentJuz(santri.id) }}
                                            </div>
                                            <div class="text-sm font-medium text-gray-900 dark:text-white">
                                                Hal. {{ getSantriProgressPage(santri.id) }}
                                            </div>
                                            <div class="text-xs text-gray-500 dark:text-gray-400">Setoran Terakhir</div>
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-2">
                                        <div class="flex justify-between text-sm">
                                            <span class="text-gray-600 dark:text-gray-400">Progress Hafalan</span>
                                            <span class="font-medium text-gray-900 dark:text-white">{{ getSantriProgressPercentage(santri.id) }}%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                                            <div class="tahfizh-progress h-2 rounded-full transition-all duration-500" 
                                                 :style="`width: ${getSantriProgressPercentage(santri.id)}%`"></div>
                                        </div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                            Target: 604 halaman (30 Juz)
                                        </div>
                                    </div>

                                    <!-- Month Progress Stats -->
                                    <div class="mt-4 grid grid-cols-3 gap-2 text-center">
                                        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-2">
                                            <div class="text-sm font-bold text-blue-600 dark:text-blue-400">
                                                {{ getMonthlySetoranPages(santri.id) }}
                                            </div>
                                            <div class="text-xs text-blue-600 dark:text-blue-400">Hal/Bulan</div>
                                        </div>
                                        <div class="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-2">
                                            <div class="text-sm font-bold text-purple-600 dark:text-purple-400">
                                                {{ getMonthlyMurojaahTotal(santri.id) }}
                                            </div>
                                            <div class="text-xs text-purple-600 dark:text-purple-400">Total Murojaah</div>
                                        </div>
                                        <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-2">
                                            <div class="text-sm font-bold text-green-600 dark:text-green-400">
                                                {{ getMonthlyExamCount(santri.id) }}
                                            </div>
                                            <div class="text-xs text-green-600 dark:text-green-400">Ujian</div>
                                        </div>
                                    </div>

                                    <!-- Latest Exam Info -->
                                    <div v-if="getLatestExam(santri.id)" class="mt-3 p-2 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
                                        <div class="text-xs text-yellow-800 dark:text-yellow-200 font-medium">
                                            <i class="fas fa-trophy mr-1"></i>
                                            Ujian Terakhir: {{ getLatestExam(santri.id) }}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div v-if="filteredSantriForRecap.length === 0" class="text-center py-12">
                                <div class="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-book-quran text-2xl text-gray-400"></i>
                                </div>
                                <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Tidak Ada Data</h4>
                                <p class="text-gray-600 dark:text-gray-400">Tidak ada santri yang sesuai dengan filter.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Admin Dashboard -->
                    <div v-if="activeTab === 'admin-dashboard'" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <div class="bg-gradient-to-br from-emerald-500 to-green-600 rounded-xl p-6 text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="text-3xl font-bold">{{ totalSantri }}</div>
                                        <div class="text-emerald-100">Total Santri</div>
                                    </div>
                                    <i class="fas fa-user-graduate text-4xl text-emerald-200"></i>
                                </div>
                            </div>
                            
                            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-6 text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="text-3xl font-bold">{{ totalMusyrif }}</div>
                                        <div class="text-blue-100">Total Musyrif</div>
                                    </div>
                                    <i class="fas fa-chalkboard-teacher text-4xl text-blue-200"></i>
                                </div>
                            </div>
                            
                            <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-6 text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="text-3xl font-bold">{{ averageProgress }}</div>
                                        <div class="text-purple-100">Rata-rata Juz</div>
                                    </div>
                                    <i class="fas fa-chart-line text-4xl text-purple-200"></i>
                                </div>
                            </div>
                            
                            <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-6 text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="text-3xl font-bold">{{ todayAttendancePercentage }}%</div>
                                        <div class="text-orange-100">Kehadiran Hari Ini</div>
                                    </div>
                                    <i class="fas fa-user-check text-4xl text-orange-200"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Progress by Angkatan -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-chart-bar mr-2 text-emerald-500"></i>Progress per Angkatan
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div v-for="angkatan in uniqueAngkatanList" :key="angkatan" 
                                     class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="font-semibold text-gray-900 dark:text-white">Angkatan {{ angkatan }}</h4>
                                        <span :class="`angkatan-${angkatan}`" class="px-2 py-1 rounded-full text-xs font-medium text-white">
                                            {{ getAngkatanCount(angkatan) }} santri
                                        </span>
                                    </div>
                                    <div class="text-2xl font-bold text-emerald-600 dark:text-emerald-400 mb-2">
                                        Juz {{ getAngkatanAverageProgressJuz(angkatan) }}
                                    </div>
                                    <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                                        <div :class="`angkatan-${angkatan}`" class="h-2 rounded-full transition-all duration-500" 
                                             :style="`width: ${getAngkatanAverageProgressPercentage(angkatan)}%`"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Admin Manage Musyrif -->
                    <div v-if="activeTab === 'manage-musyrif'" class="space-y-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
                                <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                                    <i class="fas fa-chalkboard-teacher mr-2 text-emerald-500"></i>Manajemen Musyrif
                                </h3>
                                <button @click="openMusyrifModal()" 
                                        class="px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg font-medium transition-colors flex items-center space-x-2">
                                    <i class="fas fa-plus"></i>
                                    <span>Tambah Musyrif</span>
                                </button>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div v-for="musyrif in musyrifList" :key="musyrif.id" 
                                     class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-700 dark:to-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-600">
                                    <div class="flex items-center justify-between mb-4">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-12 h-12 bg-emerald-500 text-white rounded-full flex items-center justify-center font-bold text-lg">
                                                {{ musyrif.name.charAt(0).toUpperCase() }}
                                            </div>
                                            <div>
                                                <h4 class="font-bold text-gray-900 dark:text-white">{{ musyrif.name }}</h4>
                                                <p class="text-sm text-gray-600 dark:text-gray-400">@{{ musyrif.username }}</p>
                                            </div>
                                        </div>
                                        <div class="flex space-x-2">
                                            <button @click="editMusyrif(musyrif)" 
                                                    class="p-2 text-blue-600 hover:bg-blue-100 dark:hover:bg-blue-900/20 rounded-lg transition-colors">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button @click="deleteMusyrif(musyrif.id)" 
                                                    class="p-2 text-red-600 hover:bg-red-100 dark:hover:bg-red-900/20 rounded-lg transition-colors">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-emerald-600 dark:text-emerald-400">
                                            {{ getSantriByMusyrif(musyrif.id).length }}
                                        </div>
                                        <div class="text-sm text-gray-600 dark:text-gray-400">Santri Binaan</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Admin Manage Santri -->
                    <div v-if="activeTab === 'manage-santri'" class="space-y-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
                                <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                                    <i class="fas fa-user-graduate mr-2 text-emerald-500"></i>Manajemen Santri
                                </h3>
                                <button @click="openSantriModal()" 
                                        class="px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg font-medium transition-colors flex items-center space-x-2">
                                    <i class="fas fa-plus"></i>
                                    <span>Tambah Santri</span>
                                </button>
                            </div>

                            <!-- Filter -->
                            <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Filter Angkatan</label>
                                    <select v-model="santriFilter.angkatan" 
                                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option value="">Semua Angkatan</option>
                                        <option v-for="angkatan in uniqueAngkatanList" 
                                               :key="`manage-santri-${angkatan}`" 
                                               :value="angkatan">
                                            Angkatan {{ angkatan }}
                                        </option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Filter Musyrif</label>
                                    <select v-model="santriFilter.musyrif" 
                                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option value="">Semua Musyrif</option>
                                        <option v-for="musyrif in musyrifList" :key="musyrif.id" :value="musyrif.id">
                                            {{ musyrif.name }}
                                        </option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Cari Nama</label>
                                    <input type="text" 
                                           v-model="santriFilter.search"
                                           placeholder="Ketik nama santri..."
                                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div v-for="santri in filteredSantri" :key="santri.id" 
                                     class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-700 dark:to-gray-800 rounded-xl p-6 border border-gray-200 dark:border-gray-600">
                                    <div class="flex items-center justify-between mb-4">
                                        <div>
                                            <h4 class="font-bold text-gray-900 dark:text-white">{{ santri.name }}</h4>
                                            <div class="flex items-center space-x-2 mt-1">
                                                <span :class="`angkatan-${santri.angkatan}`" class="px-2 py-1 rounded-full text-xs font-medium text-white">
                                                    Angkatan {{ santri.angkatan }}
                                                </span>
                                            </div>
                                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">{{ getMusyrifName(santri.musyrifId) }}</p>
                                        </div>
                                        <div class="flex space-x-2">
                                            <button @click="editSantri(santri)" 
                                                    class="p-2 text-blue-600 hover:bg-blue-100 dark:hover:bg-blue-900/20 rounded-lg transition-colors">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button @click="deleteSantri(santri.id)" 
                                                    class="p-2 text-red-600 hover:bg-red-100 dark:hover:bg-red-900/20 rounded-lg transition-colors">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="text-center">
                                        <div class="text-lg font-bold text-emerald-600 dark:text-emerald-400">
                                            Juz {{ getSantriCurrentJuz(santri.id) }}
                                        </div>
                                        <div class="text-sm text-gray-600 dark:text-gray-400">Halaman {{ getSantriProgressPage(santri.id) }}</div>
                                        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2 mt-2">
                                            <div class="tahfizh-progress h-2 rounded-full transition-all duration-500" 
                                                 :style="`width: ${getSantriProgressPercentage(santri.id)}%`"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Musyrif Tahfizh Input -->
                    <div v-if="activeTab === 'tahfizh-input'" class="space-y-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
                                <i class="fas fa-book-open mr-3 text-emerald-500"></i>
                                Input Progress Tahfizh - {{ getCurrentDateString() }}
                            </h2>

                            <div class="space-y-6">
                                <div v-for="santri in mySantri" :key="santri.id" 
                                     class="bg-gradient-to-r from-emerald-50 to-green-50 dark:from-gray-700 dark:to-gray-800 rounded-xl p-6 border border-emerald-200 dark:border-gray-600">
                                    <div class="flex flex-col lg:flex-row lg:items-center gap-6">
                                        <div class="flex items-center space-x-4">
                                            <div class="w-12 h-12 bg-emerald-500 text-white rounded-full flex items-center justify-center font-bold text-lg">
                                                {{ santri.name.charAt(0).toUpperCase() }}
                                            </div>
                                            <div>
                                                <h3 class="text-lg font-bold text-gray-900 dark:text-white">{{ santri.name }}</h3>
                                                <div class="flex items-center space-x-2">
                                                    <span :class="`angkatan-${santri.angkatan}`" class="px-2 py-1 rounded-full text-xs font-medium text-white">
                                                        Angkatan {{ santri.angkatan }}
                                                    </span>
                                                    <span class="text-sm text-gray-600 dark:text-gray-400">
                                                        Progress: Juz {{ getSantriCurrentJuz(santri.id) }}, Hal. {{ getSantriProgressPage(santri.id) }}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="flex-1 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                    Halaman Awal <span class="text-red-500">*</span>
                                                </label>
                                                <input type="number" 
                                                       v-model.number="tahfizhInput[santri.id].startPage"
                                                       min="1" max="604"
                                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                                       placeholder="1">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                    Halaman Akhir <span class="text-red-500">*</span>
                                                </label>
                                                <input type="number" 
                                                       v-model.number="tahfizhInput[santri.id].endPage"
                                                       min="1" max="604"
                                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                                       placeholder="1">
                                                <div v-if="tahfizhInput[santri.id].startPage && tahfizhInput[santri.id].endPage" class="juz-indicator">
                                                    Juz: {{ getJuzFromPages(tahfizhInput[santri.id].startPage, tahfizhInput[santri.id].endPage) }}
                                                </div>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                    Murojaah (Juz)
                                                </label>
                                                <input type="number" 
                                                       v-model.number="tahfizhInput[santri.id].murojaahJuz"
                                                       min="0" max="30"
                                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                                       placeholder="Jumlah juz">
                                                <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                                    Masukkan jumlah juz yang dimurojaah
                                                </div>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                    Ujian (Opsional)
                                                </label>
                                                <input type="text" 
                                                       v-model="tahfizhInput[santri.id].exam"
                                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                                       placeholder="Misal: Ujian Juz 1">
                                            </div>
                                        </div>

                                        <div>
                                            <button @click="saveTahfizhProgress(santri.id)" 
                                                    :disabled="!canSaveTahfizh(santri.id)"
                                                    :class="!canSaveTahfizh(santri.id) ? 'opacity-50 cursor-not-allowed' : 'hover:bg-emerald-700'"
                                                    class="px-6 py-2 bg-emerald-600 text-white rounded-lg font-medium transition-colors">
                                                <i class="fas fa-save mr-2"></i>Simpan
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Today's Progress Display -->
                                    <div v-if="getTodayTahfizhProgress(santri.id)" class="mt-4 p-4 bg-green-100 dark:bg-green-900/20 rounded-lg">
                                        <h4 class="font-semibold text-green-800 dark:text-green-200 mb-2">
                                            <i class="fas fa-check-circle mr-2"></i>Progress Hari Ini
                                        </h4>
                                        <div class="text-sm text-green-700 dark:text-green-300">
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                                <div>
                                                    <strong>Setoran:</strong> Halaman {{ getTodayTahfizhProgress(santri.id).startPage }} - {{ getTodayTahfizhProgress(santri.id).endPage }}
                                                    <span class="ml-2 text-blue-600 dark:text-blue-400">
                                                        ({{ getJuzFromPages(getTodayTahfizhProgress(santri.id).startPage, getTodayTahfizhProgress(santri.id).endPage) }})
                                                    </span>
                                                </div>
                                                <div v-if="getTodayTahfizhProgress(santri.id).murojaahJuz && getTodayTahfizhProgress(santri.id).murojaahJuz > 0">
                                                    <strong>Murojaah:</strong> {{ getTodayTahfizhProgress(santri.id).murojaahJuz }} Juz
                                                </div>
                                            </div>
                                            <div v-if="getTodayTahfizhProgress(santri.id).exam" class="mt-1">
                                                <strong>Ujian:</strong> {{ getTodayTahfizhProgress(santri.id).exam }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div v-if="mySantri.length === 0" class="text-center py-12">
                                <div class="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-user-graduate text-2xl text-gray-400"></i>
                                </div>
                                <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Belum Ada Santri</h4>
                                <p class="text-gray-600 dark:text-gray-400">Anda belum memiliki santri binaan.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Musyrif Ibadah Input -->
                    <div v-if="activeTab === 'ibadah-input'" class="space-y-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
                                <i class="fas fa-hands mr-3 text-emerald-500"></i>
                                Ibadah Harian Santri - {{ getCurrentDateString() }}
                            </h2>

                            <!-- Date Navigation -->
                            <div class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                                <div class="flex items-center space-x-4">
                                    <button @click="navigateDate(-1)" 
                                            class="p-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg transition-colors">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <div class="text-lg font-semibold text-gray-900 dark:text-white">
                                        {{ formatDate(selectedDate) }}
                                    </div>
                                    <button @click="navigateDate(1)" 
                                            :disabled="selectedDate >= getCurrentDate()"
                                            :class="selectedDate >= getCurrentDate() ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-300 dark:hover:bg-gray-600'"
                                            class="p-2 bg-gray-200 dark:bg-gray-700 rounded-lg transition-colors">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                                <button @click="resetToToday" 
                                        class="px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg font-medium transition-colors">
                                    <i class="fas fa-calendar-day mr-2"></i>Hari Ini
                                </button>
                            </div>

                            <!-- Spreadsheet Style Table -->
                            <div class="spreadsheet-container">
                                <table class="w-full min-w-max">
                                    <thead class="spreadsheet-header">
                                        <tr>
                                            <th class="spreadsheet-cell santri-name-cell font-semibold text-left">
                                                Santri
                                            </th>
                                            <th class="spreadsheet-cell font-semibold">
                                                Total
                                            </th>
                                            <th v-for="ibadah in ibadahList" 
                                                :key="ibadah.key" 
                                                class="spreadsheet-cell font-semibold text-xs"
                                                :title="ibadah.name">
                                                <div class="flex flex-col items-center">
                                                    <i :class="ibadah.icon + ' ' + ibadah.color" class="text-base mb-1"></i>
                                                    <span class="leading-tight">{{ ibadah.name }}</span>
                                                </div>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="santri in mySantri" :key="santri.id" 
                                            class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                            <td class="spreadsheet-cell santri-name-cell">
                                                <div class="flex items-center space-x-3">
                                                    <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold text-sm">
                                                        {{ santri.name.charAt(0).toUpperCase() }}
                                                    </div>
                                                    <div>
                                                        <div class="font-medium text-gray-900 dark:text-white text-sm">
                                                            {{ santri.name }}
                                                        </div>
                                                        <div class="text-xs text-gray-500 dark:text-gray-400">
                                                            Angkatan {{ santri.angkatan }}
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="spreadsheet-cell">
                                                <div class="flex flex-col items-center">
                                                    <div class="text-lg font-bold" 
                                                         :class="getIbadahCompletion(santri.id, selectedDate) === 100 ? 'text-green-600' : 'text-orange-600'">
                                                        {{ getIbadahCompletion(santri.id, selectedDate) }}%
                                                    </div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">
                                                        {{ getCompletedIbadahCount(santri.id, selectedDate) }}/{{ ibadahList.length }}
                                                    </div>
                                                </div>
                                            </td>
                                            <td v-for="ibadah in ibadahList" 
                                                :key="ibadah.key" 
                                                class="spreadsheet-cell">
                                                <div class="flex justify-center">
                                                    <input type="checkbox" 
                                                           :checked="isIbadahCompleted(santri.id, ibadah.key, selectedDate)"
                                                           @change="toggleIbadah(santri.id, ibadah.key, selectedDate, $event.target.checked)"
                                                           class="ibadah-checkbox w-5 h-5 text-emerald-600 bg-gray-100 border-gray-300 rounded focus:ring-emerald-500 dark:focus:ring-emerald-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Legend -->
                            <div class="mt-6 flex flex-wrap items-center gap-4 text-sm">
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-check-square text-green-600"></i>
                                    <span class="text-gray-700 dark:text-gray-300">Selesai</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <i class="far fa-square text-gray-400"></i>
                                    <span class="text-gray-700 dark:text-gray-300">Belum Selesai</span>
                                </div>
                                <div class="ml-auto text-gray-500 dark:text-gray-400">
                                    Klik checkbox untuk menandai selesai/belum selesai
                                </div>
                            </div>

                            <div v-if="mySantri.length === 0" class="text-center py-12">
                                <div class="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-user-graduate text-2xl text-gray-400"></i>
                                </div>
                                <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Belum Ada Santri</h4>
                                <p class="text-gray-600 dark:text-gray-400">Anda belum memiliki santri binaan.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Musyrif/Admin Attendance Input -->
                    <div v-if="activeTab === 'attendance-input'" class="space-y-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
                                <i class="fas fa-user-check mr-3 text-emerald-500"></i>
                                Kehadiran Halaqah - {{ getCurrentDateString() }}
                            </h2>

                            <!-- Date Navigation -->
                            <div class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                                <div class="flex items-center space-x-4">
                                    <button @click="navigateDate(-1)" 
                                            class="p-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg transition-colors">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <div class="text-lg font-semibold text-gray-900 dark:text-white">
                                        {{ formatDate(selectedDate) }}
                                    </div>
                                    <button @click="navigateDate(1)" 
                                            :disabled="selectedDate >= getCurrentDate()"
                                            :class="selectedDate >= getCurrentDate() ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-300 dark:hover:bg-gray-600'"
                                            class="p-2 bg-gray-200 dark:bg-gray-700 rounded-lg transition-colors">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                                <button @click="resetToToday" 
                                        class="px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg font-medium transition-colors">
                                    <i class="fas fa-calendar-day mr-2"></i>Hari Ini
                                </button>
                            </div>

                            <!-- Attendance Legend -->
                            <div class="mb-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <h3 class="text-sm font-semibold text-gray-900 dark:text-white mb-3">Keterangan Status Kehadiran:</h3>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-4 h-4 bg-green-500 rounded"></div>
                                        <span class="text-gray-700 dark:text-gray-300">Hadir</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-4 h-4 bg-yellow-500 rounded"></div>
                                        <span class="text-gray-700 dark:text-gray-300">Izin</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-4 h-4 bg-red-500 rounded"></div>
                                        <span class="text-gray-700 dark:text-gray-300">Sakit</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-4 h-4 bg-gray-500 rounded"></div>
                                        <span class="text-gray-700 dark:text-gray-300">Tanpa Keterangan</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Attendance Table -->
                            <div class="space-y-4">
                                <div v-for="santri in mySantri" :key="santri.id" 
                                     class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-gray-700 dark:to-gray-800 rounded-xl p-6 border border-blue-200 dark:border-gray-600">
                                    <div class="flex flex-col lg:flex-row lg:items-center gap-6">
                                        <div class="flex items-center space-x-4">
                                            <div class="w-12 h-12 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold text-lg">
                                                {{ santri.name.charAt(0).toUpperCase() }}
                                            </div>
                                            <div>
                                                <h3 class="text-lg font-bold text-gray-900 dark:text-white">{{ santri.name }}</h3>
                                                <div class="flex items-center space-x-2">
                                                    <span :class="`angkatan-${santri.angkatan}`" class="px-2 py-1 rounded-full text-xs font-medium text-white">
                                                        Angkatan {{ santri.angkatan }}
                                                    </span>
                                                    <span class="text-sm text-gray-600 dark:text-gray-400">
                                                        Kehadiran bulan ini: {{ getMonthlyAttendancePercentage(santri.id) }}%
                                                    </span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="flex-1">
                                            <div class="grid grid-cols-3 gap-4">
                                                <div v-for="(halaqah, index) in halaqahList" :key="halaqah.key" class="text-center">
                                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                                        {{ halaqah.name }}
                                                    </label>
                                                    <select v-model="attendanceInput[santri.id][halaqah.key]"
                                                            @change="saveAttendance(santri.id, halaqah.key, selectedDate, $event.target.value)"
                                                            :class="`attendance-${attendanceInput[santri.id][halaqah.key]}`"
                                                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-white font-medium">
                                                        <option value="hadir" class="bg-green-500 text-white">Hadir</option>
                                                        <option value="izin" class="bg-yellow-500 text-white">Izin</option>
                                                        <option value="sakit" class="bg-red-500 text-white">Sakit</option>
                                                        <option value="tanpa_keterangan" class="bg-gray-500 text-white">Tanpa Keterangan</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="text-center">
                                            <div class="text-lg font-bold" :class="getDailyAttendancePercentage(santri.id, selectedDate) === 100 ? 'text-green-600' : getDailyAttendancePercentage(santri.id, selectedDate) >= 67 ? 'text-yellow-600' : 'text-red-600'">
                                                {{ getDailyAttendancePercentage(santri.id, selectedDate) }}%
                                            </div>
                                            <div class="text-xs text-gray-500 dark:text-gray-400">Hari Ini</div>
                                        </div>
                                    </div>

                                    <!-- Today's Attendance Summary -->
                                    <div class="mt-4 p-3 bg-white dark:bg-gray-800 rounded-lg border">
                                        <div class="grid grid-cols-3 gap-4 text-sm">
                                            <div v-for="(halaqah, index) in halaqahList" :key="halaqah.key" class="text-center">
                                                <div class="font-medium text-gray-700 dark:text-gray-300">{{ halaqah.name }}</div>
                                                <div class="mt-1">
                                                    <span :class="`attendance-${getAttendanceStatus(santri.id, halaqah.key, selectedDate)}`" 
                                                          class="px-2 py-1 rounded text-xs font-medium">
                                                        {{ getAttendanceStatusText(getAttendanceStatus(santri.id, halaqah.key, selectedDate)) }}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div v-if="mySantri.length === 0" class="text-center py-12">
                                <div class="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-user-graduate text-2xl text-gray-400"></i>
                                </div>
                                <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Belum Ada Santri</h4>
                                <p class="text-gray-600 dark:text-gray-400">Anda belum memiliki santri binaan.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Attendance Recap -->
                    <div v-if="activeTab === 'attendance-recap'" class="space-y-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
                                <i class="fas fa-calendar-check mr-3 text-emerald-500"></i>
                                Rekap Kehadiran Halaqah
                            </h2>

                            <!-- Filter -->
                            <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Filter Bulan</label>
                                    <select v-model="attendanceFilter.month" 
                                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option v-for="month in getAvailableMonths()" :key="month.value" :value="month.value">
                                            {{ month.label }}
                                        </option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Filter Angkatan</label>
                                    <select v-model="attendanceFilter.angkatan" 
                                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option value="">Semua Angkatan</option>
                                        <option v-for="angkatan in uniqueAngkatanList" 
                                               :key="`attendance-filter-${angkatan}`" 
                                               :value="angkatan">
                                            Angkatan {{ angkatan }}
                                        </option>
                                    </select>
                                </div>
                                <div v-if="isAdmin">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Filter Musyrif</label>
                                    <select v-model="attendanceFilter.musyrif" 
                                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option value="">Semua Musyrif</option>
                                        <option v-for="musyrif in musyrifList" :key="musyrif.id" :value="musyrif.id">
                                            {{ musyrif.name }}
                                        </option>
                                    </select>
                                </div>
                            </div>

                            <!-- Summary Cards -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-green-600 dark:text-green-400">{{ getMonthlyAttendanceSummary().averageAttendance }}%</div>
                                    <div class="text-sm text-green-600 dark:text-green-400">Rata-rata Kehadiran</div>
                                </div>
                                <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">{{ getMonthlyAttendanceSummary().totalHalaqah }}</div>
                                    <div class="text-sm text-blue-600 dark:text-blue-400">Total Halaqah</div>
                                </div>
                                <div class="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-purple-600 dark:text-purple-400">{{ getMonthlyAttendanceSummary().bestAttendee.name }}</div>
                                    <div class="text-sm text-purple-600 dark:text-purple-400">Kehadiran Terbaik</div>
                                </div>
                                <div class="bg-orange-50 dark:bg-orange-900/20 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-orange-600 dark:text-orange-400">{{ getMonthlyAttendanceSummary().perfectDays }}</div>
                                    <div class="text-sm text-orange-600 dark:text-orange-400">Hari Perfect</div>
                                </div>
                            </div>

                            <!-- Attendance Table -->
                            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 overflow-x-auto">
                                <div class="min-w-max">
                                    <!-- Header -->
                                    <div class="flex bg-white dark:bg-gray-800 rounded-lg mb-2 shadow-sm">
                                        <div class="w-40 p-3 font-semibold text-gray-900 dark:text-white border-r border-gray-200 dark:border-gray-600">
                                            Santri
                                        </div>
                                        <div class="w-20 p-3 text-center font-semibold text-gray-900 dark:text-white border-r border-gray-200 dark:border-gray-600">
                                            Rata-rata
                                        </div>
                                        <div v-for="date in getDateRange(attendanceFilter.month)" :key="date" 
                                             class="w-24 p-2 text-center font-semibold text-xs text-gray-700 dark:text-gray-300 border-r border-gray-200 dark:border-gray-600">
                                            <div>{{ formatDayName(date) }}</div>
                                            <div>{{ formatDateShort(date) }}</div>
                                        </div>
                                    </div>

                                    <!-- Santri Rows -->
                                    <div v-for="santri in filteredSantriForAttendance" :key="santri.id" 
                                         class="flex bg-white dark:bg-gray-800 rounded-lg mb-2 shadow-sm hover:shadow-md transition-shadow">
                                        <!-- Santri Info -->
                                        <div class="w-40 p-3 border-r border-gray-200 dark:border-gray-600">
                                            <div class="font-medium text-gray-900 dark:text-white text-sm">{{ santri.name }}</div>
                                            <div class="flex items-center space-x-1 mt-1">
                                                <span :class="`angkatan-${santri.angkatan}`" class="px-2 py-0.5 rounded-full text-xs font-medium text-white">
                                                    {{ santri.angkatan }}
                                                </span>
                                            </div>
                                        </div>

                                        <!-- Average -->
                                        <div class="w-20 p-3 text-center border-r border-gray-200 dark:border-gray-600">
                                            <div class="text-lg font-bold" :class="getMonthlyAttendanceAverage(santri.id) >= 90 ? 'text-green-600' : getMonthlyAttendanceAverage(santri.id) >= 80 ? 'text-yellow-600' : 'text-red-600'">
                                                {{ getMonthlyAttendanceAverage(santri.id) }}%
                                            </div>
                                        </div>

                                        <!-- Daily Attendance -->
                                        <div v-for="date in getDateRange(attendanceFilter.month)" :key="date" 
                                             class="w-24 p-2 text-center border-r border-gray-200 dark:border-gray-600">
                                            <div class="halaqah-container">
                                                <div v-for="(halaqah, index) in halaqahList" :key="halaqah.key" class="halaqah-item">
                                                    <div class="w-6 h-6 mx-auto rounded-full text-xs font-bold flex items-center justify-center"
                                                         :class="`attendance-${getAttendanceStatus(santri.id, halaqah.key, date)}`">
                                                        {{ halaqah.short }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="text-xs font-bold mt-1" 
                                                 :class="getDailyAttendancePercentage(santri.id, date) === 100 ? 'text-green-600' : 
                                                        getDailyAttendancePercentage(santri.id, date) >= 67 ? 'text-yellow-600' : 'text-red-600'">
                                                {{ getDailyAttendancePercentage(santri.id, date) }}%
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Legend -->
                            <div class="mt-4 flex flex-wrap items-center gap-4 text-sm">
                                <div class="flex items-center space-x-2">
                                    <div class="w-4 h-4 bg-green-500 rounded-full"></div>
                                    <span class="text-gray-700 dark:text-gray-300">Hadir</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-4 h-4 bg-yellow-500 rounded-full"></div>
                                    <span class="text-gray-700 dark:text-gray-300">Izin</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-4 h-4 bg-red-500 rounded-full"></div>
                                    <span class="text-gray-700 dark:text-gray-300">Sakit</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-4 h-4 bg-gray-500 rounded-full"></div>
                                    <span class="text-gray-700 dark:text-gray-300">Tanpa Keterangan</span>
                                </div>
                                <div class="ml-auto text-gray-500 dark:text-gray-400">
                                    P1 = Halaqah Pagi | P2 = Halaqah Siang | P3 = Halaqah Sore
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Admin Ibadah Recap -->
                    <div v-if="activeTab === 'ibadah-recap'" class="space-y-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
                                <i class="fas fa-pray mr-3 text-emerald-500"></i>
                                Rekap Ibadah Harian Santri
                            </h2>

                            <!-- Filter -->
                            <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Filter Bulan</label>
                                    <select v-model="ibadahFilter.month" 
                                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option v-for="month in getAvailableMonths()" :key="month.value" :value="month.value">
                                            {{ month.label }}
                                        </option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Filter Angkatan</label>
                                    <select v-model="ibadahFilter.angkatan" 
                                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option value="">Semua Angkatan</option>
                                        <option v-for="angkatan in uniqueAngkatanList" 
                                               :key="`ibadah-filter-${angkatan}`" 
                                               :value="angkatan">
                                            Angkatan {{ angkatan }}
                                        </option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Filter Musyrif</label>
                                    <select v-model="ibadahFilter.musyrif" 
                                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option value="">Semua Musyrif</option>
                                        <option v-for="musyrif in musyrifList" :key="musyrif.id" :value="musyrif.id">
                                            {{ musyrif.name }}
                                        </option>
                                    </select>
                                </div>
                            </div>

                            <!-- Summary Cards -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-green-600 dark:text-green-400">{{ getMonthlyIbadahSummary().averageCompletion }}%</div>
                                    <div class="text-sm text-green-600 dark:text-green-400">Rata-rata Bulan Ini</div>
                                </div>
                                <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">{{ getMonthlyIbadahSummary().totalDays }}</div>
                                    <div class="text-sm text-blue-600 dark:text-blue-400">Total Hari</div>
                                </div>
                                <div class="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-purple-600 dark:text-purple-400">{{ getMonthlyIbadahSummary().bestPerformer.name }}</div>
                                    <div class="text-sm text-purple-600 dark:text-purple-400">Terbaik</div>
                                </div>
                                <div class="bg-orange-50 dark:bg-orange-900/20 rounded-lg p-4 text-center">
                                    <div class="text-2xl font-bold text-orange-600 dark:text-orange-400">{{ getMonthlyIbadahSummary().completeDays }}</div>
                                    <div class="text-sm text-orange-600 dark:text-orange-400">Hari Lengkap</div>
                                </div>
                            </div>

                            <!-- Spreadsheet Style Ibadah Table -->
                            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 overflow-x-auto">
                                <div class="min-w-max">
                                    <!-- Header -->
                                    <div class="flex bg-white dark:bg-gray-800 rounded-lg mb-2 shadow-sm">
                                        <div class="w-40 p-3 font-semibold text-gray-900 dark:text-white border-r border-gray-200 dark:border-gray-600">
                                            Santri
                                        </div>
                                        <div class="w-20 p-3 text-center font-semibold text-gray-900 dark:text-white border-r border-gray-200 dark:border-gray-600">
                                            Rata-rata
                                        </div>
                                        <div v-for="date in getDateRange(ibadahFilter.month)" :key="date" 
                                             class="w-16 p-2 text-center font-semibold text-xs text-gray-700 dark:text-gray-300 border-r border-gray-200 dark:border-gray-600">
                                            <div>{{ formatDayName(date) }}</div>
                                            <div>{{ formatDateShort(date) }}</div>
                                        </div>
                                    </div>

                                    <!-- Santri Rows -->
                                    <div v-for="santri in filteredSantriForIbadah" :key="santri.id" 
                                         class="flex bg-white dark:bg-gray-800 rounded-lg mb-2 shadow-sm hover:shadow-md transition-shadow">
                                        <!-- Santri Info -->
                                        <div class="w-40 p-3 border-r border-gray-200 dark:border-gray-600">
                                            <div class="font-medium text-gray-900 dark:text-white text-sm">{{ santri.name }}</div>
                                            <div class="flex items-center space-x-1 mt-1">
                                                <span :class="`angkatan-${santri.angkatan}`" class="px-2 py-0.5 rounded-full text-xs font-medium text-white">
                                                    {{ santri.angkatan }}
                                                </span>
                                            </div>
                                        </div>

                                        <!-- Average -->
                                     <!-- Average -->
<div class="w-20 p-3 text-center border-r border-gray-200 dark:border-gray-600">
    <div class="text-lg font-bold cursor-pointer hover:scale-110 transition-transform duration-200" 
         :class="getMonthlyIbadahAverage(santri.id) >= 80 ? 'text-green-600 hover:text-green-700' : 
                 getMonthlyIbadahAverage(santri.id) >= 60 ? 'text-yellow-600 hover:text-yellow-700' : 
                 'text-red-600 hover:text-red-700'"
         @click="showIbadahMonthlyDetail(santri.id, ibadahFilter.month)"
         title="Klik untuk melihat detail per ibadah">
        {{ getMonthlyIbadahAverage(santri.id) }}%
    </div>
    <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Klik detail</div>
</div>

                                        <!-- Daily Progress -->
                                        <div v-for="date in getDateRange(ibadahFilter.month)" :key="date" 
                                             class="w-16 p-2 text-center border-r border-gray-200 dark:border-gray-600">
                                            <div class="w-10 h-10 mx-auto rounded-full flex items-center justify-center text-xs font-bold"
                                                 :class="getIbadahCompletion(santri.id, date) === 100 ? 'bg-green-500 text-white' : 
                                                        getIbadahCompletion(santri.id, date) >= 80 ? 'bg-yellow-500 text-white' :
                                                        getIbadahCompletion(santri.id, date) >= 50 ? 'bg-orange-500 text-white' :
                                                        getIbadahCompletion(santri.id, date) > 0 ? 'bg-red-500 text-white' : 'bg-gray-300 text-gray-600'"
                                                 @click="openIbadahDetail(santri.id, date)"
                                                 style="cursor: pointer;">
                                                {{ getIbadahCompletion(santri.id, date) }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Legend -->
                            <div class="mt-4 flex flex-wrap items-center gap-4 text-sm">
                                <div class="flex items-center space-x-2">
                                    <div class="w-4 h-4 bg-green-500 rounded-full"></div>
                                    <span class="text-gray-700 dark:text-gray-300">100% Lengkap</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-4 h-4 bg-yellow-500 rounded-full"></div>
                                    <span class="text-gray-700 dark:text-gray-300">80-99% Hampir Lengkap</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-4 h-4 bg-orange-500 rounded-full"></div>
                                    <span class="text-gray-700 dark:text-gray-300">50-79% Sebagian</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-4 h-4 bg-red-500 rounded-full"></div>
                                    <span class="text-gray-700 dark:text-gray-300">1-49% Sedikit</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-4 h-4 bg-gray-300 rounded-full"></div>
                                    <span class="text-gray-700 dark:text-gray-300">0% Tidak Ada</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auto-save indicator -->
    <transition name="fade">
        <div v-if="autoSaving" class="fixed bottom-4 left-4 bg-emerald-500 text-white px-4 py-2 rounded-lg shadow-lg">
            <i class="fas fa-sync-alt animate-spin mr-2"></i>
            Menyimpan...
        </div>
    </transition>

    <script>
        const { createApp, ref, computed, onMounted, watch, reactive, nextTick } = Vue;
        const { createClient } = supabase;

        const app = createApp({
            setup() {
                // Supabase configuration
                const supabaseClient = ref(null);
                const connectionStatus = ref('disconnected'); // 'connected', 'disconnected', 'connecting'
                const showConfigModal = ref(false);
                const isConnecting = ref(false);
                const dbConfig = reactive({
                    supabaseUrl: 'https://rxjfjrcpmaexsfacfejj.supabase.co',
                    supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4amZqcmNwbWFleHNmYWNmZWpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyNzQ5MDYsImV4cCI6MjA2ODg1MDkwNn0.xHNHBZtepd9PPMZBRbiFFq-7eXv70cu-iFyeK-vQ0ys'
                });

                // Core state
                const loading = ref(true);
                const isLoggedIn = ref(false);
                const isAdmin = ref(false);
                const isMusyrif = ref(false);
                const isPublicAccess = ref(false);
                const currentUser = ref(null);
                const activeTab = ref('admin-dashboard');
                const darkMode = ref(false);
                const autoSaving = ref(false);
                const isSubmitting = ref(false);
                const isLoggingIn = ref(false);
                const loginError = ref('');
                const selectedDate = ref(getCurrentDate());

                // UI state
                const showSantriModal = ref(false);
                const showMusyrifModal = ref(false);
                const editingSantri = ref(null);
                const editingMusyrif = ref(null);

                // Forms
                const credentials = reactive({
                    username: '',
                    password: ''
                });

                const santriForm = reactive({
                    name: '',
                    angkatan: '',
                    musyrifId: ''
                });

                const musyrifForm = reactive({
                    name: '',
                    username: '',
                    password: ''
                });

                // Filters
                const santriFilter = reactive({
                    angkatan: '',
                    musyrif: '',
                    search: ''
                });

                const tahfizhFilter = reactive({
                    angkatan: '',
                    musyrif: '',
                    sort: 'progress',
                    month: getCurrentMonth()
                });

                const ibadahFilter = reactive({
                    month: getCurrentMonth(),
                    angkatan: '',
                    musyrif: ''
                });

                const attendanceFilter = reactive({
                    month: getCurrentMonth(),
                    angkatan: '',
                    musyrif: ''
                });

                // Data
                const musyrifList = ref([
                    { id: 'mus-1', name: 'Ustadzah Min Ai', username: 'aminah', password: 'aminah123' },
                    { id: 'mus-2', name: 'Ustadzah Arini', username: 'arini ', password: 'arini123' },
                
                ]);

                const santriList = ref([
                    { id: 'santri-1', name: 'Zainab', angkatan: 9, musyrifId: 'mus-1' },
                    { id: 'santri-2', name: 'Salamah', angkatan: 10, musyrifId: 'mus-2' },
                
                ]);

                const adminUsers = ref([
                    { id: 'admin-1', username: 'adminputri', password: 'admin123', name: 'Administrator', role: 'admin' }
                ]);

                const notifications = ref([]);

                // Progress data
                const tahfizhProgress = ref({});
                const ibadahProgress = ref({});
                const attendanceProgress = ref({});
                const tahfizhInput = ref({});
                const ibadahInput = ref({});
                const attendanceInput = ref({});

                // Halaqah (3x tatap muka) list
                const halaqahList = ref([
                    { key: 'halaqah_1', name: 'Halaqah Pagi', short: 'P1' },
                    { key: 'halaqah_2', name: 'Halaqah Siang', short: 'P2' },
                    { key: 'halaqah_3', name: 'Halaqah Sore', short: 'P3' }
                ]);

                // Attendance status options
                const attendanceStatusOptions = ref([
                    { value: 'hadir', label: 'Hadir', color: 'green' },
                    { value: 'izin', label: 'Izin', color: 'yellow' },
                    { value: 'sakit', label: 'Sakit', color: 'red' },
                    { value: 'tanpa_keterangan', label: 'Tanpa Keterangan', color: 'gray' }
                ]);

                // Juz mapping for calculations
                const juzMapping = ref([
                    { number: 1, startPage: 1, endPage: 21 },
                    { number: 2, startPage: 22, endPage: 41 },
                    { number: 3, startPage: 42, endPage: 61 },
                    { number: 4, startPage: 62, endPage: 81 },
                    { number: 5, startPage: 82, endPage: 101 },
                    { number: 6, startPage: 102, endPage: 121 },
                    { number: 7, startPage: 122, endPage: 141 },
                    { number: 8, startPage: 142, endPage: 161 },
                    { number: 9, startPage: 162, endPage: 181 },
                    { number: 10, startPage: 182, endPage: 201 },
                    { number: 11, startPage: 202, endPage: 221 },
                    { number: 12, startPage: 222, endPage: 241 },
                    { number: 13, startPage: 242, endPage: 261 },
                    { number: 14, startPage: 262, endPage: 281 },
                    { number: 15, startPage: 282, endPage: 301 },
                    { number: 16, startPage: 302, endPage: 321 },
                    { number: 17, startPage: 322, endPage: 341 },
                    { number: 18, startPage: 342, endPage: 361 },
                    { number: 19, startPage: 362, endPage: 381 },
                    { number: 20, startPage: 382, endPage: 401 },
                    { number: 21, startPage: 402, endPage: 421 },
                    { number: 22, startPage: 422, endPage: 441 },
                    { number: 23, startPage: 442, endPage: 461 },
                    { number: 24, startPage: 462, endPage: 481 },
                    { number: 25, startPage: 482, endPage: 501 },
                    { number: 26, startPage: 502, endPage: 521 },
                    { number: 27, startPage: 522, endPage: 541 },
                    { number: 28, startPage: 542, endPage: 561 },
                    { number: 29, startPage: 562, endPage: 581 },
                    { number: 30, startPage: 582, endPage: 604 }
                ]);

                // Ibadah list
                const ibadahList = ref([
                    { key: 'ql', name: 'QL', icon: 'fas fa-sun', color: 'text-yellow-500' },
                    { key: 'sholat', name: 'Sholat Wajib', icon: 'fas fa-sun', color: 'text-orange-500' },
                    { key: 'matsurat', name: 'Matsurat', icon: 'fas fa-sun', color: 'text-amber-500' },
                    { key: 'piket', name: 'Piket', icon: 'fas fa-moon', color: 'text-purple-500' },
                    { key: 'dirosah', name: 'Dirosah', icon: 'fas fa-moon', color: 'text-indigo-500' },
                    { key: 'olahraga', name: 'Olahraga', icon: 'fas fa-star', color: 'text-blue-500' },
                    { key: 'lima_s', name: '5 S', icon: 'fas fa-sun', color: 'text-green-500' },
                    { key: 'baca', name: 'Baca buku', icon: 'fas fa-book-quran', color: 'text-emerald-500' },
                    { key: 'murojaahsholat', name: 'Murojaah Dalam Sholat (5)', icon: 'fas fa-hands', color: 'text-teal-500' },
                    { key: 'sedekah', name: 'Sedekah', icon: 'fas fa-hand-holding-heart', color: 'text-pink-500' }
                ]);

                // Helper functions
                function getJakartaDate() {
                    const now = new Date();
                    const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
                    return new Date(utc + (7 * 3600000)); // UTC+7 Jakarta
                }

                function getCurrentDate() {
                    return getJakartaDate().toISOString().split('T')[0];
                }

                function getCurrentMonth() {
                    return getJakartaDate().toISOString().split('T')[0].substring(0, 7);
                }

                function getAvailableMonths() {
                    const months = [];
                    const startDate = new Date('2025-07-01'); // Mulai dari Juli 2025
                    const currentDate = getJakartaDate();
                    
                    let date = new Date(startDate);
                    while (date <= currentDate) {
                        const yearMonth = date.toISOString().split('T')[0].substring(0, 7);
                        months.push({
                            value: yearMonth,
                            label: date.toLocaleDateString('id-ID', { 
                                year: 'numeric', 
                                month: 'long' 
                            })
                        });
                        date.setMonth(date.getMonth() + 1);
                    }
                    
                    return months.reverse(); // Terbaru di atas
                }

                function getDaysInMonth(yearMonth) {
                    const [year, month] = yearMonth.split('-');
                    const date = new Date(year, month, 0);
                    return date.getDate();
                }

                function getDateRange(yearMonth) {
                    const [year, month] = yearMonth.split('-');
                    const daysInMonth = getDaysInMonth(yearMonth);
                    const dates = [];
                    
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateStr = `${year}-${month.padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                        dates.push(dateStr);
                    }
                    
                    return dates;
                }

                // Function to get Juz from page range
                const getJuzFromPages = (startPage, endPage) => {
                    if (!startPage || !endPage) return '';
                    
                    const start = parseInt(startPage);
                    const end = parseInt(endPage);
                    
                    // Find juz for start page
                    const startJuz = juzMapping.value.find(juz => start >= juz.startPage && start <= juz.endPage);
                    // Find juz for end page
                    const endJuz = juzMapping.value.find(juz => end >= juz.startPage && end <= juz.endPage);
                    
                    if (startJuz && endJuz) {
                        if (startJuz.number === endJuz.number) {
                            return `Juz ${startJuz.number}`;
                        } else {
                            return `Juz ${startJuz.number} - ${endJuz.number}`;
                        }
                    }
                    
                    return '';
                };

                const getCurrentDateString = () => {
                    const jakarta = getJakartaDate();
                    return jakarta.toLocaleDateString('id-ID', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                };

                const formatDate = (dateString) => {
                    const date = new Date(dateString + 'T00:00:00.000Z');
                    return date.toLocaleDateString('id-ID', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                };

                const formatDateShort = (dateString) => {
                    const date = new Date(dateString + 'T00:00:00.000Z');
                    return date.toLocaleDateString('id-ID', {
                        day: '2-digit',
                        month: 'short'
                    });
                };

                const formatDayName = (dateString) => {
                    const date = new Date(dateString + 'T00:00:00.000Z');
                    return date.toLocaleDateString('id-ID', {
                        weekday: 'short'
                    });
                };

                // Navigation functions
                const navigateDate = (direction) => {
                    const currentDate = new Date(selectedDate.value);
                    currentDate.setDate(currentDate.getDate() + direction);
                    selectedDate.value = currentDate.toISOString().split('T')[0];
                };

                const resetToToday = () => {
                    selectedDate.value = getCurrentDate();
                };

                // Supabase functions
                const initializeSupabase = () => {
                    try {
                        if (dbConfig.supabaseUrl && dbConfig.supabaseKey) {
                            supabaseClient.value = createClient(dbConfig.supabaseUrl, dbConfig.supabaseKey);
                            return true;
                        }
                        return false;
                    } catch (error) {
                        console.error('Error initializing Supabase:', error);
                        return false;
                    }
                };

                const testConnection = async () => {
                    if (!supabaseClient.value) return false;
                    
                    try {
                        connectionStatus.value = 'connecting';
                        
                        // Test dengan query sederhana ke table musyrif
                        const { data, error } = await supabaseClient.value
                            .from('musyrif')
                            .select('id')
                            .limit(1);
                        
                        if (error) {
                            console.error('Connection test failed:', error);
                            connectionStatus.value = 'disconnected';
                            
                            // Coba test dengan admin_users jika musyrif belum ada
                            const { data: adminData, error: adminError } = await supabaseClient.value
                                .from('admin_users')
                                .select('id')
                                .limit(1);
                                
                            if (adminError) {
                                console.error('Admin test also failed:', adminError);
                                return false;
                            }
                        }
                        
                        connectionStatus.value = 'connected';
                        console.log('Successfully connected to Supabase');
                        return true;
                        
                    } catch (error) {
                        console.error('Connection test error:', error);
                        connectionStatus.value = 'disconnected';
                        return false;
                    }
                };

                const setupRealtimeSubscriptions = () => {
                    if (!supabaseClient.value || connectionStatus.value !== 'connected') return;

                    // Subscribe to musyrif changes
                    supabaseClient.value
                        .channel('musyrif_changes')
                        .on('postgres_changes', { event: '*', schema: 'public', table: 'musyrif' }, 
                            payload => {
                                console.log('Musyrif change received:', payload);
                                syncFromSupabase();
                            })
                        .subscribe();

                    // Subscribe to santri changes
                    supabaseClient.value
                        .channel('santri_changes')
                        .on('postgres_changes', { event: '*', schema: 'public', table: 'santri' }, 
                            payload => {
                                console.log('Santri change received:', payload);
                                syncFromSupabase();
                            })
                        .subscribe();

                    // Subscribe to tahfizh_progress changes
                    supabaseClient.value
                        .channel('tahfizh_changes')
                        .on('postgres_changes', { event: '*', schema: 'public', table: 'tahfizh_progress' }, 
                            payload => {
                                console.log('Tahfizh change received:', payload);
                                syncFromSupabase();
                            })
                        .subscribe();

                    // Subscribe to ibadah_progress changes
                    supabaseClient.value
                        .channel('ibadah_changes')
                        .on('postgres_changes', { event: '*', schema: 'public', table: 'ibadah_progress' }, 
                            payload => {
                                console.log('Ibadah change received:', payload);
                                syncFromSupabase();
                            })
                        .subscribe();

                    // Subscribe to attendance_progress changes
                    supabaseClient.value
                        .channel('attendance_changes')
                        .on('postgres_changes', { event: '*', schema: 'public', table: 'attendance_progress' }, 
                            payload => {
                                console.log('Attendance change received:', payload);
                                syncFromSupabase();
                            })
                        .subscribe();
                };

                const syncToSupabase = async () => {
                    if (!supabaseClient.value || connectionStatus.value !== 'connected') return;

                    try {
                        autoSaving.value = true;

                        // Sync musyrif data
                        for (const musyrif of musyrifList.value) {
                            await supabaseClient.value
                                .from('musyrif')
                                .upsert({
                                    id: musyrif.id,
                                    name: musyrif.name,
                                    username: musyrif.username,
                                    password: musyrif.password,
                                    updated_at: new Date().toISOString()
                                }, {
                                    onConflict: 'id'
                                });
                        }

                        // Sync santri data
                        for (const santri of santriList.value) {
                            await supabaseClient.value
                                .from('santri')
                                .upsert({
                                    id: santri.id,
                                    name: santri.name,
                                    angkatan: santri.angkatan,
                                    musyrif_id: santri.musyrifId,
                                    updated_at: new Date().toISOString()
                                }, {
                                    onConflict: 'id'
                                });
                        }

                        // Sync tahfizh progress data
                        for (const [santriId, progressData] of Object.entries(tahfizhProgress.value)) {
                            for (const [date, dayProgress] of Object.entries(progressData)) {
                                await supabaseClient.value
                                    .from('tahfizh_progress')
                                    .upsert({
                                        santri_id: santriId,
                                        date: date,
                                        start_page: dayProgress.startPage,
                                        end_page: dayProgress.endPage,
                                        murojaah_juz: dayProgress.murojaahJuz || 0,
                                        exam: dayProgress.exam,
                                        timestamp: dayProgress.timestamp,
                                        musyrif_id: currentUser.value?.id,
                                        updated_at: new Date().toISOString()
                                    }, {
                                        onConflict: 'santri_id,date'
                                    });
                            }
                        }

                        // Sync ibadah data - IMPROVED VERSION
                        for (const [santriId, progressData] of Object.entries(ibadahProgress.value)) {
                            for (const [date, dayProgress] of Object.entries(progressData)) {
                                // Prepare data for both column structure and JSONB
                                const ibadahData = {
                                    santri_id: santriId,
                                    date: date,
                                    // Individual columns
                                    ql: dayProgress.ql || false,
                                    sholat: dayProgress.sholat || false,
                                    matsurat: dayProgress.matsurat || false,
                                    piket: dayProgress.piket || false,
                                    dirosah: dayProgress.dirosah || false,
                                    olahraga: dayProgress.olahraga || false,
                                    lima_s: dayProgress.lima_s || false,
                                    baca: dayProgress.baca || false,
                                    murojaahsholat: dayProgress.murojaahsholat || false,
                                    sedekah: dayProgress.sedekah || false,
                                    // JSONB backup
                                    progress_data: JSON.stringify(dayProgress),
                                    musyrif_id: currentUser.value?.id,
                                    updated_at: new Date().toISOString()
                                };

                                await supabaseClient.value
                                    .from('ibadah_progress')
                                    .upsert(ibadahData, {
                                        onConflict: 'santri_id,date'
                                    });
                            }
                        }

                        // Sync attendance data - IMPROVED VERSION
                        for (const [santriId, progressData] of Object.entries(attendanceProgress.value)) {
                            for (const [date, dayProgress] of Object.entries(progressData)) {
                                const attendanceData = {
                                    santri_id: santriId,
                                    date: date,
                                    // Individual columns
                                    halaqah_1: dayProgress.halaqah_1 || 'tanpa_keterangan',
                                    halaqah_2: dayProgress.halaqah_2 || 'tanpa_keterangan',
                                    halaqah_3: dayProgress.halaqah_3 || 'tanpa_keterangan',
                                    // JSONB backup
                                    attendance_data: JSON.stringify(dayProgress),
                                    timestamp: dayProgress.timestamp,
                                    musyrif_id: currentUser.value?.id,
                                    updated_at: new Date().toISOString()
                                };

                                await supabaseClient.value
                                    .from('attendance_progress')
                                    .upsert(attendanceData, {
                                        onConflict: 'santri_id,date'
                                    });
                            }
                        }

                        autoSaving.value = false;
                        console.log('Data berhasil disinkronisasi ke Supabase');
                        
                    } catch (error) {
                        console.error('Error syncing to Supabase:', error);
                        autoSaving.value = false;
                        connectionStatus.value = 'disconnected';
                        showNotification('Gagal menyinkronkan data: ' + error.message, 'error');
                    }
                };

                const syncFromSupabase = async () => {
                    if (!supabaseClient.value || connectionStatus.value !== 'connected') return;

                    try {
                        console.log('Memuat data dari Supabase...');

                        // Fetch musyrif data
                        const { data: musyrifData, error: musyrifError } = await supabaseClient.value
                            .from('musyrif')
                            .select('*')
                            .eq('is_active', true);
                        
                        if (musyrifError) throw musyrifError;
                        
                        if (musyrifData && musyrifData.length > 0) {
                            musyrifList.value = musyrifData.map(item => ({
                                id: item.id,
                                name: item.name,
                                username: item.username,
                                password: item.password
                            }));
                            console.log(`Loaded ${musyrifData.length} musyrif records`);
                        }

                        // Fetch santri data
                        const { data: santriData, error: santriError } = await supabaseClient.value
                            .from('santri')
                            .select('*')
                            .eq('is_active', true);
                        
                        if (santriError) throw santriError;
                        
                        if (santriData && santriData.length > 0) {
                            santriList.value = santriData.map(item => ({
                                id: item.id,
                                name: item.name,
                                angkatan: item.angkatan,
                                musyrifId: item.musyrif_id
                            }));
                            console.log(`Loaded ${santriData.length} santri records`);
                        }

                        // Fetch tahfizh progress
                        const { data: tahfizhData, error: tahfizhError } = await supabaseClient.value
                            .from('tahfizh_progress')
                            .select('*')
                            .order('date', { ascending: false });
                        
                        if (tahfizhError) throw tahfizhError;
                        
                        if (tahfizhData && tahfizhData.length > 0) {
                            const newTahfizhProgress = {};
                            tahfizhData.forEach(item => {
                                if (!newTahfizhProgress[item.santri_id]) {
                                    newTahfizhProgress[item.santri_id] = {};
                                }
                                newTahfizhProgress[item.santri_id][item.date] = {
                                    date: item.date,
                                    startPage: item.start_page,
                                    endPage: item.end_page,
                                    murojaahJuz: item.murojaah_juz || 0,
                                    exam: item.exam,
                                    timestamp: item.timestamp || item.created_at
                                };
                            });
                            tahfizhProgress.value = newTahfizhProgress;
                            console.log(`Loaded ${tahfizhData.length} tahfizh progress records`);
                        }

                        // Fetch ibadah progress - IMPROVED VERSION
                        const { data: ibadahData, error: ibadahError } = await supabaseClient.value
                            .from('ibadah_progress')
                            .select('*')
                            .order('date', { ascending: false });
                        
                        if (ibadahError) throw ibadahError;
                        
                        if (ibadahData && ibadahData.length > 0) {
                            const newIbadahProgress = {};
                            ibadahData.forEach(item => {
                                if (!newIbadahProgress[item.santri_id]) {
                                    newIbadahProgress[item.santri_id] = {};
                                }
                                
                                // Try to use individual columns first, fallback to JSONB
                                let dayProgress = {};
                                
                                if (item.ql !== null || item.sholat !== null) {
                                    // Use individual columns
                                    dayProgress = {
                                        ql: item.ql || false,
                                        sholat: item.sholat || false,
                                        matsurat: item.matsurat || false,
                                        piket: item.piket || false,
                                        dirosah: item.dirosah || false,
                                        olahraga: item.olahraga || false,
                                        lima_s: item.lima_s || false,
                                        baca: item.baca || false,
                                        murojaahsholat: item.murojaahsholat || false,
                                        sedekah: item.sedekah || false,
                                        timestamp: item.created_at
                                    };
                                } else if (item.progress_data) {
                                    // Fallback to JSONB
                                    try {
                                        dayProgress = JSON.parse(item.progress_data);
                                    } catch (e) {
                                        console.error('Error parsing ibadah progress_data:', e);
                                        dayProgress = {};
                                    }
                                }
                                
                                newIbadahProgress[item.santri_id][item.date] = dayProgress;
                            });
                            ibadahProgress.value = newIbadahProgress;
                            console.log(`Loaded ${ibadahData.length} ibadah progress records`);
                        }

                        // Fetch attendance progress - IMPROVED VERSION
                        const { data: attendanceData, error: attendanceError } = await supabaseClient.value
                            .from('attendance_progress')
                            .select('*')
                            .order('date', { ascending: false });
                        
                        if (attendanceError) throw attendanceError;
                        
                        if (attendanceData && attendanceData.length > 0) {
                            const newAttendanceProgress = {};
                            attendanceData.forEach(item => {
                                if (!newAttendanceProgress[item.santri_id]) {
                                    newAttendanceProgress[item.santri_id] = {};
                                }
                                
                                // Try to use individual columns first, fallback to JSONB
                                let dayProgress = {};
                                
                                if (item.halaqah_1 || item.halaqah_2 || item.halaqah_3) {
                                    // Use individual columns
                                    dayProgress = {
                                        halaqah_1: item.halaqah_1 || 'tanpa_keterangan',
                                        halaqah_2: item.halaqah_2 || 'tanpa_keterangan',
                                        halaqah_3: item.halaqah_3 || 'tanpa_keterangan',
                                        timestamp: item.timestamp || item.created_at
                                    };
                                } else if (item.attendance_data) {
                                    // Fallback to JSONB
                                    try {
                                        dayProgress = JSON.parse(item.attendance_data);
                                    } catch (e) {
                                        console.error('Error parsing attendance_data:', e);
                                        dayProgress = {};
                                    }
                                }
                                
                                newAttendanceProgress[item.santri_id][item.date] = dayProgress;
                            });
                            attendanceProgress.value = newAttendanceProgress;
                            console.log(`Loaded ${attendanceData.length} attendance progress records`);
                        }

                        console.log('Data berhasil dimuat dari Supabase');
                        showNotification('Data berhasil disinkronisasi', 'success');

                    } catch (error) {
                        console.error('Error syncing from Supabase:', error);
                        connectionStatus.value = 'disconnected';
                        showNotification('Gagal memuat data: ' + error.message, 'error');
                    }
                };

                // Configuration functions
                const openConfigModal = () => {
                    showConfigModal.value = true;
                };

                const closeConfigModal = () => {
                    showConfigModal.value = false;
                };

                const saveDbConfig = async () => {
                    isConnecting.value = true;
                    
                    try {
                        // Save config to localStorage
                        localStorage.setItem('supabaseUrl', dbConfig.supabaseUrl);
                        localStorage.setItem('supabaseKey', dbConfig.supabaseKey);
                        
                        // Initialize Supabase client
                        const success = initializeSupabase();
                        if (success) {
                            const connected = await testConnection();
                            if (connected) {
                                setupRealtimeSubscriptions();
                                await syncFromSupabase();
                                showNotification('Berhasil terhubung ke database!', 'success');
                                closeConfigModal();
                            } else {
                                showNotification('Gagal terhubung ke database. Periksa URL dan Key.', 'error');
                            }
                        } else {
                            showNotification('Konfigurasi tidak valid', 'error');
                        }
                    } catch (error) {
                        console.error('Error saving config:', error);
                        showNotification('Error: ' + error.message, 'error');
                    } finally {
                        isConnecting.value = false;
                    }
                };

                const loadDbConfig = () => {
                    const savedUrl = localStorage.getItem('supabaseUrl');
                    const savedKey = localStorage.getItem('supabaseKey');
                    
                    if (savedUrl && savedKey) {
                        dbConfig.supabaseUrl = savedUrl;
                        dbConfig.supabaseKey = savedKey;
                        return true;
                    }
                    return false;
                };

                // Computed properties
                const totalSantri = computed(() => santriList.value.length);
                const totalMusyrif = computed(() => musyrifList.value.length);

                const averageProgress = computed(() => {
                    if (santriList.value.length === 0) return 0;
                    const total = santriList.value.reduce((sum, santri) => sum + getSantriCurrentJuz(santri.id), 0);
                    return Math.round(total / santriList.value.length);
                });

                const todayIbadahCompletion = computed(() => {
                    const today = getCurrentDate();
                    let totalCompletion = 0;
                    let count = 0;
                    
                    santriList.value.forEach(santri => {
                        const completion = getIbadahCompletion(santri.id, today);
                        totalCompletion += completion;
                        count++;
                    });
                    
                    return count > 0 ? Math.round(totalCompletion / count) : 0;
                });

                const todayAttendancePercentage = computed(() => {
                    const today = getCurrentDate();
                    let totalAttendance = 0;
                    let count = 0;
                    
                    santriList.value.forEach(santri => {
                        const attendance = getDailyAttendancePercentage(santri.id, today);
                        totalAttendance += attendance;
                        count++;
                    });
                    
                    return count > 0 ? Math.round(totalAttendance / count) : 0;
                });

                const availableMonths = computed(() => getAvailableMonths());

                const mySantri = computed(() => {
                    if (!currentUser.value || !isMusyrif.value) return [];
                    return santriList.value.filter(santri => santri.musyrifId === currentUser.value.id);
                });

                // FIXED: Unique angkatan list
                const uniqueAngkatanList = computed(() => {
                    const angkatanSet = new Set();
                    santriList.value.forEach(santri => {
                        if (santri.angkatan != null && santri.angkatan !== '') {
                            angkatanSet.add(santri.angkatan);
                        }
                    });
                    return Array.from(angkatanSet).sort((a, b) => a - b);
                });

                const filteredSantri = computed(() => {
                    let filtered = santriList.value;
                    
                    if (santriFilter.angkatan) {
                        filtered = filtered.filter(santri => santri.angkatan === parseInt(santriFilter.angkatan));
                    }
                    
                    if (santriFilter.musyrif) {
                        filtered = filtered.filter(santri => santri.musyrifId === santriFilter.musyrif);
                    }
                    
                    if (santriFilter.search) {
                        filtered = filtered.filter(santri => 
                            santri.name.toLowerCase().includes(santriFilter.search.toLowerCase())
                        );
                    }
                    
                    return filtered;
                });

                const filteredSantriForRecap = computed(() => {
                    let filtered = santriList.value;
                    
                    if (tahfizhFilter.angkatan) {
                        filtered = filtered.filter(santri => santri.angkatan === parseInt(tahfizhFilter.angkatan));
                    }
                    
                    if (tahfizhFilter.musyrif) {
                        filtered = filtered.filter(santri => santri.musyrifId === tahfizhFilter.musyrif);
                    }
                    
                    // Sort
                    switch (tahfizhFilter.sort) {
                        case 'progress':
                            filtered.sort((a, b) => getSantriProgressPage(b.id) - getSantriProgressPage(a.id));
                            break;
                        case 'name':
                            filtered.sort((a, b) => a.name.localeCompare(b.name));
                            break;
                        case 'angkatan':
                            filtered.sort((a, b) => a.angkatan - b.angkatan);
                            break;
                    }
                    
                    return filtered;
                });

                const filteredSantriForIbadah = computed(() => {
                    let filtered = santriList.value;
                    
                    if (ibadahFilter.angkatan) {
                        filtered = filtered.filter(santri => santri.angkatan === parseInt(ibadahFilter.angkatan));
                    }
                    
                    if (ibadahFilter.musyrif) {
                        filtered = filtered.filter(santri => santri.musyrifId === ibadahFilter.musyrif);
                    }
                    
                    return filtered;
                });

                const filteredSantriForAttendance = computed(() => {
                    let filtered = isMusyrif.value ? mySantri.value : santriList.value;
                    
                    if (attendanceFilter.angkatan) {
                        filtered = filtered.filter(santri => santri.angkatan === parseInt(attendanceFilter.angkatan));
                    }
                    
                    if (attendanceFilter.musyrif && isAdmin.value) {
                        filtered = filtered.filter(santri => santri.musyrifId === attendanceFilter.musyrif);
                    }
                    
                    return filtered;
                });

                const isSantriFormValid = computed(() => {
                    return santriForm.name.trim() && santriForm.angkatan && santriForm.musyrifId;
                });

                const isMusyrifFormValid = computed(() => {
                    if (!musyrifForm.name.trim() || !musyrifForm.username.trim()) return false;
                    if (!editingMusyrif.value && !musyrifForm.password.trim()) return false;
                    if (!editingMusyrif.value) {
                        const existing = musyrifList.value.find(m => m.username === musyrifForm.username.trim());
                        if (existing) return false;
                    }
                    return true;
                });

                // Connection status computed
                const connectionStatusClass = computed(() => {
                    switch (connectionStatus.value) {
                        case 'connected': return 'status-connected';
                        case 'connecting': return 'status-connecting';
                        default: return 'status-disconnected';
                    }
                });

                const connectionStatusIcon = computed(() => {
                    switch (connectionStatus.value) {
                        case 'connected': return 'fas fa-wifi';
                        case 'connecting': return 'fas fa-spinner fa-spin';
                        default: return 'fas fa-wifi-slash';
                    }
                });

                const connectionStatusText = computed(() => {
                    switch (connectionStatus.value) {
                        case 'connected': return 'Terhubung';
                        case 'connecting': return 'Menghubungkan...';
                        default: return 'Tidak Terhubung';
                    }
                });

                // Methods
                const toggleDarkMode = () => {
                    darkMode.value = !darkMode.value;
                    
                    if (darkMode.value) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                };

                const showNotification = (message, type = 'info', duration = 5000) => {
                    const id = Date.now() + Math.random();
                    const notification = { id, message, type };
                    
                    notifications.value.push(notification);
                    
                    if (duration > 0) {
                        setTimeout(() => removeNotification(id), duration);
                    }
                    
                    return id;
                };

                const removeNotification = (id) => {
                    const index = notifications.value.findIndex(n => n.id === id);
                    if (index > -1) {
                        notifications.value.splice(index, 1);
                    }
                };

                const getNotificationClass = (type) => {
                    const classes = {
                        'success': 'bg-green-500 text-white',
                        'error': 'bg-red-500 text-white',
                        'info': 'bg-blue-500 text-white',
                        'warning': 'bg-yellow-500 text-white'
                    };
                    return classes[type] || classes.info;
                };

                const getNotificationIcon = (type) => {
                    const icons = {
                        'success': 'fas fa-check-circle',
                        'error': 'fas fa-exclamation-circle',
                        'info': 'fas fa-info-circle',
                        'warning': 'fas fa-exclamation-triangle'
                    };
                    return icons[type] || icons.info;
                };

                // Authentication
                const login = async () => {
                    loginError.value = '';
                    
                    // Check admin
                    const admin = adminUsers.value.find(user => 
                        user.username === credentials.username && 
                        user.password === credentials.password
                    );
                    
                    if (admin) {
                        isLoggingIn.value = true;
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                        currentUser.value = admin;
                        isAdmin.value = true;
                        isMusyrif.value = false;
                        isLoggedIn.value = true;
                        isLoggingIn.value = false;
                        activeTab.value = 'admin-dashboard';
                        return;
                    }
                    
                    // Check musyrif
                    const musyrif = musyrifList.value.find(user => 
                        user.username === credentials.username && 
                        user.password === credentials.password
                    );
                    
                    if (musyrif) {
                        isLoggingIn.value = true;
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                        currentUser.value = musyrif;
                        isAdmin.value = false;
                        isMusyrif.value = true;
                        isLoggedIn.value = true;
                        isLoggingIn.value = false;
                        activeTab.value = 'tahfizh-input';
                        return;
                    }
                    
                    loginError.value = 'Username atau password salah';
                };

                const logout = () => {
                    isLoggedIn.value = false;
                    isAdmin.value = false;
                    isMusyrif.value = false;
                    isPublicAccess.value = false;
                    currentUser.value = null;
                    credentials.username = '';
                    credentials.password = '';
                    activeTab.value = 'admin-dashboard';
                    loginError.value = '';
                };

                const accessPublic = () => {
                    isPublicAccess.value = true;
                    isLoggedIn.value = false;
                };

                const backToLogin = () => {
                    isPublicAccess.value = false;
                };

                // Santri Management
                const openSantriModal = (santri = null) => {
                    editingSantri.value = santri;
                    if (santri) {
                        santriForm.name = santri.name;
                        santriForm.angkatan = santri.angkatan;
                        santriForm.musyrifId = santri.musyrifId;
                    } else {
                        Object.assign(santriForm, {
                            name: '',
                            angkatan: '',
                            musyrifId: ''
                        });
                    }
                    showSantriModal.value = true;
                };

                const closeSantriModal = () => {
                    showSantriModal.value = false;
                    editingSantri.value = null;
                    Object.assign(santriForm, {
                        name: '',
                        angkatan: '',
                        musyrifId: ''
                    });
                };

                const saveSantri = async () => {
                    if (!isSantriFormValid.value) {
                        showNotification('Lengkapi semua field yang diperlukan', 'error');
                        return;
                    }

                    isSubmitting.value = true;

                    try {
                        await new Promise(resolve => setTimeout(resolve, 1000));

                        if (editingSantri.value) {
                            const index = santriList.value.findIndex(s => s.id === editingSantri.value.id);
                            if (index !== -1) {
                                santriList.value[index] = {
                                    ...santriList.value[index],
                                    name: santriForm.name.trim(),
                                    angkatan: santriForm.angkatan,
                                    musyrifId: santriForm.musyrifId
                                };
                            }
                            showNotification('Data santri berhasil diupdate', 'success');
                        } else {
                            const newSantri = {
                                id: 'santri-' + Date.now(),
                                name: santriForm.name.trim(),
                                angkatan: santriForm.angkatan,
                                musyrifId: santriForm.musyrifId
                            };
                            
                            santriList.value.push(newSantri);
                            showNotification('Santri baru berhasil ditambahkan', 'success');
                        }

                        autoSave();
                        closeSantriModal();
                        
                    } catch (error) {
                        console.error('Error saving santri:', error);
                        showNotification('Gagal menyimpan data santri', 'error');
                    } finally {
                        isSubmitting.value = false;
                    }
                };

                const editSantri = (santri) => {
                    openSantriModal(santri);
                };

                const deleteSantri = (santriId) => {
                    if (confirm('Apakah Anda yakin ingin menghapus santri ini?')) {
                        const index = santriList.value.findIndex(s => s.id === santriId);
                        if (index !== -1) {
                            santriList.value.splice(index, 1);
                            // Also delete progress data
                            delete tahfizhProgress.value[santriId];
                            delete ibadahProgress.value[santriId];
                            delete attendanceProgress.value[santriId];
                            autoSave();
                            showNotification('Santri berhasil dihapus', 'success');
                        }
                    }
                };

                // Musyrif Management
                const openMusyrifModal = (musyrif = null) => {
                    editingMusyrif.value = musyrif;
                    if (musyrif) {
                        musyrifForm.name = musyrif.name;
                        musyrifForm.username = musyrif.username;
                        musyrifForm.password = '';
                    } else {
                        Object.assign(musyrifForm, {
                            name: '',
                            username: '',
                            password: ''
                        });
                    }
                    showMusyrifModal.value = true;
                };

                const closeMusyrifModal = () => {
                    showMusyrifModal.value = false;
                    editingMusyrif.value = null;
                    Object.assign(musyrifForm, {
                        name: '',
                        username: '',
                        password: ''
                    });
                };

                const saveMusyrif = async () => {
                    if (!isMusyrifFormValid.value) {
                        showNotification('Lengkapi form dengan benar', 'error');
                        return;
                    }

                    isSubmitting.value = true;

                    try {
                        await new Promise(resolve => setTimeout(resolve, 1000));

                        if (editingMusyrif.value) {
                            const index = musyrifList.value.findIndex(m => m.id === editingMusyrif.value.id);
                            if (index !== -1) {
                                musyrifList.value[index] = {
                                    ...musyrifList.value[index],
                                    name: musyrifForm.name.trim()
                                };

                                if (musyrifForm.password.trim()) {
                                    musyrifList.value[index].password = musyrifForm.password.trim();
                                }
                            }
                            showNotification('Data musyrif berhasil diupdate', 'success');
                        } else {
                            const newMusyrif = {
                                id: 'mus-' + Date.now(),
                                name: musyrifForm.name.trim(),
                                username: musyrifForm.username.trim(),
                                password: musyrifForm.password.trim()
                            };
                            
                            musyrifList.value.push(newMusyrif);
                            showNotification('Musyrif baru berhasil ditambahkan', 'success');
                        }

                        autoSave();
                        closeMusyrifModal();
                        
                    } catch (error) {
                        console.error('Error saving musyrif:', error);
                        showNotification('Gagal menyimpan data musyrif', 'error');
                    } finally {
                        isSubmitting.value = false;
                    }
                };

                const editMusyrif = (musyrif) => {
                    openMusyrifModal(musyrif);
                };

                const deleteMusyrif = (musyrifId) => {
                    if (confirm('Apakah Anda yakin ingin menghapus musyrif ini?')) {
                        const index = musyrifList.value.findIndex(m => m.id === musyrifId);
                        if (index !== -1) {
                            musyrifList.value.splice(index, 1);
                            autoSave();
                            showNotification('Musyrif berhasil dihapus', 'success');
                        }
                    }
                };

                // Helper functions
                const getMusyrifName = (musyrifId) => {
                    const musyrif = musyrifList.value.find(m => m.id === musyrifId);
                    return musyrif ? musyrif.name : 'Unknown';
                };

                const getSantriByMusyrif = (musyrifId) => {
                    return santriList.value.filter(santri => santri.musyrifId === musyrifId);
                };

                const getAngkatanCount = (angkatan) => {
                    return santriList.value.filter(santri => santri.angkatan === angkatan).length;
                };

                const getAngkatanAverageProgressJuz = (angkatan) => {
                    const santriAngkatan = santriList.value.filter(santri => santri.angkatan === angkatan);
                    if (santriAngkatan.length === 0) return 0;
                    const total = santriAngkatan.reduce((sum, santri) => sum + getSantriCurrentJuz(santri.id), 0);
                    return Math.round(total / santriAngkatan.length);
                };

                const getAngkatanAverageProgressPercentage = (angkatan) => {
                    const santriAngkatan = santriList.value.filter(santri => santri.angkatan === angkatan);
                    if (santriAngkatan.length === 0) return 0;
                    const total = santriAngkatan.reduce((sum, santri) => sum + getSantriProgressPercentage(santri.id), 0);
                    return Math.round(total / santriAngkatan.length);
                };

                // Progress functions
                const getSantriProgressPage = (santriId) => {
                    const progress = tahfizhProgress.value[santriId];
                    if (!progress) return 0;
                    
                    let maxPage = 0;
                    Object.values(progress).forEach(dayProgress => {
                        if (dayProgress.endPage > maxPage) {
                            maxPage = dayProgress.endPage;
                        }
                    });
                    
                    return maxPage;
                };

                const getSantriCurrentJuz = (santriId) => {
                    const page = getSantriProgressPage(santriId);
                    if (page === 0) return 0;
                    
                    // Find which juz this page belongs to
                    for (let i = 0; i < juzMapping.value.length; i++) {
                        const juz = juzMapping.value[i];
                        if (page >= juz.startPage && page <= juz.endPage) {
                            return juz.number;
                        }
                    }
                    
                    // If page exceeds all juz, return 30
                    if (page > 604) return 30;
                    
                    return Math.ceil(page / 20.13); // Approximate calculation if not found
                };

                const getSantriProgressPercentage = (santriId) => {
                    const page = getSantriProgressPage(santriId);
                    return Math.round((page / 604) * 100);
                };

                const getMonthlySetoranPages = (santriId) => {
                    const progress = tahfizhProgress.value[santriId];
                    if (!progress) return 0;
                    
                    const dates = getDateRange(tahfizhFilter.month);
                    let totalPages = 0;
                    
                    dates.forEach(date => {
                        const dayProgress = progress[date];
                        if (dayProgress && dayProgress.startPage && dayProgress.endPage) {
                            totalPages += (dayProgress.endPage - dayProgress.startPage + 1);
                        }
                    });
                    
                    return totalPages;
                };

                const getMonthlyMurojaahTotal = (santriId) => {
                    const progress = tahfizhProgress.value[santriId];
                    if (!progress) return 0;
                    
                    const dates = getDateRange(tahfizhFilter.month);
                    let totalJuz = 0;
                    
                    dates.forEach(date => {
                        const dayProgress = progress[date];
                        if (dayProgress && dayProgress.murojaahJuz) {
                            totalJuz += dayProgress.murojaahJuz;
                        }
                    });
                    
                    return totalJuz;
                };

                const getMonthlyExamCount = (santriId) => {
                    const progress = tahfizhProgress.value[santriId];
                    if (!progress) return 0;
                    
                    const dates = getDateRange(tahfizhFilter.month);
                    let examCount = 0;
                    
                    dates.forEach(date => {
                        const dayProgress = progress[date];
                        if (dayProgress && dayProgress.exam && dayProgress.exam.trim()) {
                            examCount++;
                        }
                    });
                    
                    return examCount;
                };

                const getLatestExam = (santriId) => {
                    const progress = tahfizhProgress.value[santriId];
                    if (!progress) return null;
                    
                    const dates = getDateRange(tahfizhFilter.month).reverse(); // Latest first
                    
                    for (const date of dates) {
                        const dayProgress = progress[date];
                        if (dayProgress && dayProgress.exam && dayProgress.exam.trim()) {
                            return dayProgress.exam;
                        }
                    }
                    
                    return null;
                };

                const initializeTahfizhInput = () => {
                    mySantri.value.forEach(santri => {
                        if (!tahfizhInput.value[santri.id]) {
                            tahfizhInput.value[santri.id] = {
                                startPage: '',
                                endPage: '',
                                murojaahJuz: 0,
                                exam: ''
                            };
                        }
                    });
                };

                const initializeIbadahInput = () => {
                    mySantri.value.forEach(santri => {
                        if (!ibadahInput.value[santri.id]) {
                            ibadahInput.value[santri.id] = {};
                            ibadahList.value.forEach(ibadah => {
                                ibadahInput.value[santri.id][ibadah.key] = false;
                            });
                        }
                        
                        // Load today's ibadah data
                        const today = getCurrentDate();
                        const todayIbadah = ibadahProgress.value[santri.id]?.[today];
                        if (todayIbadah) {
                            ibadahList.value.forEach(ibadah => {
                                ibadahInput.value[santri.id][ibadah.key] = todayIbadah[ibadah.key] || false;
                            });
                        }
                    });
                };

                const initializeAttendanceInput = () => {
                    mySantri.value.forEach(santri => {
                        if (!attendanceInput.value[santri.id]) {
                            attendanceInput.value[santri.id] = {};
                        }
                        
                        // Initialize all halaqah for this santri
                        halaqahList.value.forEach(halaqah => {
                            if (!attendanceInput.value[santri.id][halaqah.key]) {
                                attendanceInput.value[santri.id][halaqah.key] = 'tanpa_keterangan';
                            }
                        });
                        
                        // Load today's attendance data
                        const today = selectedDate.value;
                        const todayAttendance = attendanceProgress.value[santri.id]?.[today];
                        if (todayAttendance) {
                            halaqahList.value.forEach(halaqah => {
                                attendanceInput.value[santri.id][halaqah.key] = todayAttendance[halaqah.key] || 'tanpa_keterangan';
                            });
                        }
                    });
                };

                // Attendance functions
                const saveAttendance = async (santriId, halaqahKey, date, status) => {
                    // Update local state first
                    if (!attendanceProgress.value[santriId]) {
                        attendanceProgress.value[santriId] = {};
                    }
                    
                    if (!attendanceProgress.value[santriId][date]) {
                        attendanceProgress.value[santriId][date] = {
                            date: date,
                            timestamp: new Date().toISOString()
                        };
                        
                        // Initialize all halaqah for this date
                        halaqahList.value.forEach(halaqah => {
                            attendanceProgress.value[santriId][date][halaqah.key] = 'tanpa_keterangan';
                        });
                    }
                    
                    attendanceProgress.value[santriId][date][halaqahKey] = status;
                    attendanceProgress.value[santriId][date].timestamp = new Date().toISOString();
                    
                    // Sync to Supabase if connected
                    if (supabaseClient.value && connectionStatus.value === 'connected') {
                        try {
                            const currentData = attendanceProgress.value[santriId][date];
                            
                            const attendanceData = {
                                santri_id: santriId,
                                date: date,
                                halaqah_1: currentData.halaqah_1 || 'tanpa_keterangan',
                                halaqah_2: currentData.halaqah_2 || 'tanpa_keterangan', 
                                halaqah_3: currentData.halaqah_3 || 'tanpa_keterangan',
                                attendance_data: JSON.stringify(currentData),
                                timestamp: currentData.timestamp,
                                musyrif_id: currentUser.value?.id,
                                updated_at: new Date().toISOString()
                            };
                            
                            const { error } = await supabaseClient.value
                                .from('attendance_progress')
                                .upsert(attendanceData, {
                                    onConflict: 'santri_id,date'
                                });
                                
                            if (error) {
                                console.error('Error syncing attendance to Supabase:', error);
                                showNotification('Gagal menyimpan data kehadiran: ' + error.message, 'error');
                            }
                        } catch (error) {
                            console.error('Error syncing attendance to Supabase:', error);
                            showNotification('Gagal menyimpan data kehadiran', 'error');
                        }
                    }
                    
                    // Save to localStorage as backup
                    autoSave();
                };

                const getAttendanceStatus = (santriId, halaqahKey, date) => {
                    return attendanceProgress.value[santriId]?.[date]?.[halaqahKey] || 'tanpa_keterangan';
                };

                const getAttendanceStatusText = (status) => {
                    const statusMap = {
                        'hadir': 'Hadir',
                        'izin': 'Izin',
                        'sakit': 'Sakit',
                        'tanpa_keterangan': 'Alpha'
                    };
                    return statusMap[status] || 'Alpha';
                };

                const getDailyAttendancePercentage = (santriId, date) => {
                    const attendance = attendanceProgress.value[santriId]?.[date];
                    if (!attendance) return 0;
                    
                    let presentCount = 0;
                    halaqahList.value.forEach(halaqah => {
                        if (attendance[halaqah.key] === 'hadir') {
                            presentCount++;
                        }
                    });
                    
                    return Math.round((presentCount / halaqahList.value.length) * 100);
                };

                const getMonthlyAttendanceAverage = (santriId) => {
                    const dates = getDateRange(attendanceFilter.month);
                    const currentDate = getCurrentDate();
                    const validDates = dates.filter(date => date <= currentDate);
                    
                    if (validDates.length === 0) return 0;
                    
                    let totalPercentage = 0;
                    validDates.forEach(date => {
                        totalPercentage += getDailyAttendancePercentage(santriId, date);
                    });
                    
                    return Math.round(totalPercentage / validDates.length);
                };

                const getMonthlyAttendancePercentage = (santriId) => {
                    return getMonthlyAttendanceAverage(santriId);
                };

                const getMonthlyAttendanceSummary = () => {
                    const dates = getDateRange(attendanceFilter.month);
                    const currentDate = getCurrentDate();
                    const validDates = dates.filter(date => date <= currentDate);
                    
                    let totalAttendance = 0;
                    let perfectDays = 0;
                    let totalSantri = filteredSantriForAttendance.value.length;
                    let bestAttendee = { name: '-', score: 0 };
                    
                    filteredSantriForAttendance.value.forEach(santri => {
                        const monthlyAvg = getMonthlyAttendanceAverage(santri.id);
                        totalAttendance += monthlyAvg;
                        
                        if (monthlyAvg > bestAttendee.score) {
                            bestAttendee = { name: santri.name, score: monthlyAvg };
                        }
                        
                        // Count perfect days (100% attendance)
                        validDates.forEach(date => {
                            if (getDailyAttendancePercentage(santri.id, date) === 100) {
                                perfectDays++;
                            }
                        });
                    });
                    
                    const totalHalaqah = validDates.length * halaqahList.value.length;
                    
                    return {
                        averageAttendance: totalSantri > 0 ? Math.round(totalAttendance / totalSantri) : 0,
                        totalHalaqah,
                        perfectDays,
                        bestAttendee
                    };
                };

                const canSaveTahfizh = (santriId) => {
                    const input = tahfizhInput.value[santriId];
                    return input && input.startPage && input.endPage && 
                           parseInt(input.startPage) <= parseInt(input.endPage);
                };

                const saveTahfizhProgress = (santriId) => {
                    const input = tahfizhInput.value[santriId];
                    const today = getCurrentDate();
                    
                    if (!tahfizhProgress.value[santriId]) {
                        tahfizhProgress.value[santriId] = {};
                    }
                    
                    tahfizhProgress.value[santriId][today] = {
                        date: today,
                        startPage: parseInt(input.startPage),
                        endPage: parseInt(input.endPage),
                        murojaahJuz: parseInt(input.murojaahJuz) || 0,
                        exam: input.exam.trim() || null,
                        timestamp: new Date().toISOString()
                    };
                    
                    // Reset form
                    tahfizhInput.value[santriId] = {
                        startPage: '',
                        endPage: '',
                        murojaahJuz: 0,
                        exam: ''
                    };
                    
                    autoSave();
                    showNotification('Progress tahfizh berhasil disimpan', 'success');
                };

                const getTodayTahfizhProgress = (santriId) => {
                    const today = getCurrentDate();
                    return tahfizhProgress.value[santriId]?.[today];
                };

                // Enhanced toggleIbadah function with better error handling
                const toggleIbadah = async (santriId, ibadahKey, date, value) => {
                    console.log(`Toggling ibadah: ${santriId}, ${ibadahKey}, ${date}, ${value}`);
                    
                    // Update local state first (optimistic update)
                    updateLocalIbadah(santriId, ibadahKey, date, value);
                    
                    // Sync to Supabase if connected
                    if (supabaseClient.value && connectionStatus.value === 'connected') {
                        try {
                            // Get current day's data
                            const currentData = ibadahProgress.value[santriId]?.[date] || {};
                            
                            // Prepare full day data for upsert
                            const ibadahData = {
                                santri_id: santriId,
                                date: date,
                                ql: currentData.ql || false,
                                sholat: currentData.sholat || false,
                                matsurat: currentData.matsurat || false,
                                piket: currentData.piket || false,
                                dirosah: currentData.dirosah || false,
                                olahraga: currentData.olahraga || false,
                                lima_s: currentData.lima_s || false,
                                baca: currentData.baca || false,
                                murojaahsholat: currentData.murojaahsholat || false,
                                sedekah: currentData.sedekah || false,
                                progress_data: JSON.stringify(currentData),
                                musyrif_id: currentUser.value?.id,
                                updated_at: new Date().toISOString()
                            };
                            
                            // Update the specific field
                            ibadahData[ibadahKey] = value;
                            currentData[ibadahKey] = value;
                            ibadahData.progress_data = JSON.stringify(currentData);
                            
                            const { error } = await supabaseClient.value
                                .from('ibadah_progress')
                                .upsert(ibadahData, {
                                    onConflict: 'santri_id,date'
                                });
                                
                            if (error) {
                                console.error('Error syncing ibadah to Supabase:', error);
                                // Rollback UI if sync failed
                                updateLocalIbadah(santriId, ibadahKey, date, !value);
                                showNotification('Gagal menyimpan data ibadah: ' + error.message, 'error');
                            }
                        } catch (error) {
                            console.error('Error syncing ibadah to Supabase:', error);
                            // Rollback UI if sync failed
                            updateLocalIbadah(santriId, ibadahKey, date, !value);
                            showNotification('Gagal menyimpan data ibadah', 'error');
                        }
                    }
                };

                // Helper function to update local ibadah state
                const updateLocalIbadah = (santriId, ibadahKey, date, value) => {
                    if (!ibadahProgress.value[santriId]) {
                        ibadahProgress.value[santriId] = {};
                    }
                    
                    if (!ibadahProgress.value[santriId][date]) {
                        ibadahProgress.value[santriId][date] = {
                            date: date,
                            timestamp: new Date().toISOString()
                        };
                        
                        // Initialize all ibadah for this date
                        ibadahList.value.forEach(ibadah => {
                            ibadahProgress.value[santriId][date][ibadah.key] = false;
                        });
                    }
                    
                    ibadahProgress.value[santriId][date][ibadahKey] = value;
                    ibadahProgress.value[santriId][date].timestamp = new Date().toISOString();
                };

                const saveIbadahProgress = (santriId, date = null) => {
                    const targetDate = date || getCurrentDate();
                    
                    if (!ibadahProgress.value[santriId]) {
                        ibadahProgress.value[santriId] = {};
                    }
                    
                    ibadahProgress.value[santriId][targetDate] = {
                        date: targetDate,
                        ...ibadahInput.value[santriId],
                        timestamp: new Date().toISOString()
                    };
                    
                    autoSave();
                };

                const saveIbadahForDate = (santriId, ibadahKey, date, value) => {
                    if (!ibadahProgress.value[santriId]) {
                        ibadahProgress.value[santriId] = {};
                    }
                    
                    if (!ibadahProgress.value[santriId][date]) {
                        ibadahProgress.value[santriId][date] = {
                            date: date,
                            timestamp: new Date().toISOString()
                        };
                        
                        // Initialize all ibadah for this date
                        ibadahList.value.forEach(ibadah => {
                            ibadahProgress.value[santriId][date][ibadah.key] = false;
                        });
                    }
                    
                    ibadahProgress.value[santriId][date][ibadahKey] = value;
                    ibadahProgress.value[santriId][date].timestamp = new Date().toISOString();
                    
                    autoSave();
                };

                const getMonthlyIbadahAverage = (santriId) => {
                    const dates = getDateRange(ibadahFilter.month);
                    let totalCompletion = 0;
                    let validDays = 0;
                    
                    dates.forEach(date => {
                        const currentDate = getCurrentDate();
                        if (date <= currentDate) { // Only count days that have passed
                            totalCompletion += getIbadahCompletion(santriId, date);
                            validDays++;
                        }
                    });
                    
                    return validDays > 0 ? Math.round(totalCompletion / validDays) : 0;
                };

const getMonthlyIbadahDetailBySantri = (santriId, targetMonth = null) => {
    const month = targetMonth || ibadahFilter.month;
    const dates = getDateRange(month);
    const currentDate = getCurrentDate();
    const validDates = dates.filter(date => date <= currentDate);
    
    if (validDates.length === 0) return {};
    
    const ibadahDetails = {};
    
    // Initialize semua ibadah
    ibadahList.value.forEach(ibadah => {
        ibadahDetails[ibadah.key] = {
            name: ibadah.name,
            completed: 0,
            total: validDates.length,
            percentage: 0
        };
    });
    
    // Hitung completion untuk setiap ibadah
    validDates.forEach(date => {
        const dayIbadah = ibadahProgress.value[santriId]?.[date];
        if (dayIbadah) {
            ibadahList.value.forEach(ibadah => {
                if (dayIbadah[ibadah.key] === true) {
                    ibadahDetails[ibadah.key].completed++;
                }
            });
        }
    });
    
    // Hitung persentase
    Object.keys(ibadahDetails).forEach(key => {
        const detail = ibadahDetails[key];
        if (detail.total > 0) {
            detail.percentage = Math.round((detail.completed / detail.total) * 100);
        }
    });
    
    return ibadahDetails;
};

const showIbadahMonthlyDetail = (santriId, targetMonth = null) => {
    try {
        const month = targetMonth || ibadahFilter.month;
        const santri = santriList.value.find(s => s.id === santriId);
        
        if (!santri) {
            showNotification('Santri tidak ditemukan', 'error');
            return;
        }
        
        const monthLabel = availableMonths.value.find(m => m.value === month)?.label || month;
        const details = getMonthlyIbadahDetailBySantri(santriId, month);
        
        if (Object.keys(details).length === 0) {
            showNotification(`Tidak ada data ibadah untuk ${santri.name} pada ${monthLabel}`, 'warning');
            return;
        }
        
        const overallAverage = getMonthlyIbadahAverage(santriId);
        
        // Buat array untuk setiap kategori
        const categories = {
            excellent: { items: [], label: '✅ Sangat Baik (90-100%)', color: 'success' },
            good: { items: [], label: '👍 Baik (70-89%)', color: 'info' },
            fair: { items: [], label: '⚠️ Cukup (50-69%)', color: 'warning' },
            poor: { items: [], label: '❌ Perlu Perbaikan (0-49%)', color: 'error' }
        };
        
        // Kelompokkan ibadah berdasarkan persentase
        Object.values(details).forEach(detail => {
            const item = `${detail.name}: ${detail.percentage}% (${detail.completed}/${detail.total} hari)`;
            
            if (detail.percentage >= 90) {
                categories.excellent.items.push(item);
            } else if (detail.percentage >= 70) {
                categories.good.items.push(item);
            } else if (detail.percentage >= 50) {
                categories.fair.items.push(item);
            } else {
                categories.poor.items.push(item);
            }
        });
        
        // Buat pesan
        let message = `📊 Detail Ibadah ${santri.name} - ${monthLabel} | Rata-rata: ${overallAverage}%`;
        
        // Tambahkan detail per kategori (hanya yang tidak kosong)
        Object.values(categories).forEach(category => {
            if (category.items.length > 0) {
                message += ` | ${category.label}: ${category.items.join(', ')}`;
            }
        });
        
        // Tambahkan motivasi
        let motivation = '';
        if (overallAverage >= 90) {
            motivation = ' | 🌟 Masya Allah, prestasi luar biasa!';
        } else if (overallAverage >= 80) {
            motivation = ' | 👏 Alhamdulillah, pertahankan!';
        } else if (overallAverage >= 70) {
            motivation = ' | 💪 Baik, terus tingkatkan!';
        } else {
            motivation = ' | 🤲 Semangat perbaiki amal ibadah!';
        }
        
        message += motivation;
        
        // Tentukan tipe notifikasi
        const notificationType = overallAverage >= 85 ? 'success' : 
                                overallAverage >= 70 ? 'info' : 
                                overallAverage >= 50 ? 'warning' : 'error';
        
        showNotification(message, notificationType, 12000);
        
    } catch (error) {
        console.error('Error in showIbadahMonthlyDetail:', error);
        showNotification('Error menampilkan detail ibadah', 'error');
    }
};
                const getMonthlyIbadahSummary = () => {
                    const dates = getDateRange(ibadahFilter.month);
                    const currentDate = getCurrentDate();
                    const validDates = dates.filter(date => date <= currentDate);
                    
                    let totalCompletion = 0;
                    let completeDays = 0;
                    let totalSantri = filteredSantriForIbadah.value.length;
                    let bestPerformer = { name: '-', score: 0 };
                    
                    filteredSantriForIbadah.value.forEach(santri => {
                        const monthlyAvg = getMonthlyIbadahAverage(santri.id);
                        totalCompletion += monthlyAvg;
                        
                        if (monthlyAvg > bestPerformer.score) {
                            bestPerformer = { name: santri.name, score: monthlyAvg };
                        }
                        
                        // Count complete days (100%)
                        validDates.forEach(date => {
                            if (getIbadahCompletion(santri.id, date) === 100) {
                                completeDays++;
                            }
                        });
                    });
                    
                    return {
                        averageCompletion: totalSantri > 0 ? Math.round(totalCompletion / totalSantri) : 0,
                        totalDays: validDates.length,
                        completeDays,
                        bestPerformer
                    };
                };

                const openIbadahDetail = (santriId, date) => {
                    try {
                        const completion = getIbadahCompletion(santriId, date);
                        const santri = santriList.value.find(s => s.id === santriId);
                        const formattedDate = formatDate(date);
                        const incompleteIbadah = getIncompleteIbadahList(santriId, date);
                        const completedCount = getCompletedIbadahCount(santriId, date);
                        const totalIbadah = ibadahList.value.length;
                        
                        // Buat pesan dasar
                        let message = `${santri.name} - ${formattedDate} | Progress: ${completion}% (${completedCount}/${totalIbadah} selesai)`;
                        
                        // Tambahkan daftar yang belum dikerjakan
                        if (incompleteIbadah.length > 0) {
                            message += ` | Belum dikerjakan: ${incompleteIbadah.join(', ')}`;
                        } else {
                            message += ` | ✅ Semua ibadah lengkap!`;
                        }
                        
                        // Tentukan tipe notifikasi
                        const notificationType = completion === 100 ? 'success' : 
                                            completion >= 80 ? 'warning' : 
                                            completion >= 50 ? 'info' : 'error';
                        
                        showNotification(message, notificationType, 10000);
                        
                    } catch (error) {
                        console.error('Error in openIbadahDetail:', error);
                        showNotification('Error menampilkan detail ibadah', 'error');
                    }
                };

                const getTodayIbadahCompletion = (santriId) => {
                    const today = getCurrentDate();
                    return getIbadahCompletion(santriId, today);
                };

                const getIbadahCompletion = (santriId, date) => {
                    const dayIbadah = ibadahProgress.value[santriId]?.[date];
                    if (!dayIbadah) return 0;
                    
                    let completed = 0;
                    ibadahList.value.forEach(ibadah => {
                        if (dayIbadah[ibadah.key]) completed++;
                    });
                    
                    return Math.round((completed / ibadahList.value.length) * 100);
                };

                const getCompletedIbadahCount = (santriId, date = null) => {
                    const targetDate = date || getCurrentDate();
                    const dayIbadah = ibadahProgress.value[santriId]?.[targetDate];
                    if (!dayIbadah) return 0;
                    
                    let completed = 0;
                    ibadahList.value.forEach(ibadah => {
                        if (dayIbadah[ibadah.key]) completed++;
                    });
                    
                    return completed;
                };

                            const getIncompleteIbadahList = (santriId, date) => {
                const dayIbadah = ibadahProgress.value[santriId]?.[date];
                if (!dayIbadah) {
                    // Jika tidak ada data, semua ibadah dianggap tidak dikerjakan
                    return ibadahList.value.map(ibadah => ibadah.name);
                }
                
                const incompleteList = [];
                ibadahList.value.forEach(ibadah => {
                    if (!dayIbadah[ibadah.key]) {
                        incompleteList.push(ibadah.name);
                    }
                });
                
                return incompleteList;
            };
                const isIbadahCompleted = (santriId, ibadahKey, date) => {
                    return ibadahProgress.value[santriId]?.[date]?.[ibadahKey] || false;
                };

                const getIbadahSummary = () => {
                    const dates = getDateRange(ibadahFilter.month);
                    const currentDate = getCurrentDate();
                    const validDates = dates.filter(date => date <= currentDate);
                    
                    let complete = 0;
                    let partial = 0;
                    let incomplete = 0;
                    let totalPercentage = 0;
                    let count = 0;
                    
                    filteredSantriForIbadah.value.forEach(santri => {
                        validDates.forEach(date => {
                            const completion = getIbadahCompletion(santri.id, date);
                            totalPercentage += completion;
                            count++;
                            
                            if (completion === 100) {
                                complete++;
                            } else if (completion > 0) {
                                partial++;
                            } else {
                                incomplete++;
                            }
                        });
                    });
                    
                    return {
                        complete,
                        partial,
                        incomplete,
                        average: count > 0 ? Math.round(totalPercentage / count) : 0
                    };
                };

                // Storage & Sync
                const loadFromStorage = () => {
                    try {
                        const savedMusyrif = localStorage.getItem('musyrifList');
                        if (savedMusyrif) {
                            musyrifList.value = JSON.parse(savedMusyrif);
                        }

                        const savedSantri = localStorage.getItem('santriList');
                        if (savedSantri) {
                            santriList.value = JSON.parse(savedSantri);
                        }

                        const savedTahfizh = localStorage.getItem('tahfizhProgress');
                        if (savedTahfizh) {
                            tahfizhProgress.value = JSON.parse(savedTahfizh);
                        }

                        const savedIbadah = localStorage.getItem('ibadahProgress');
                        if (savedIbadah) {
                            ibadahProgress.value = JSON.parse(savedIbadah);
                        }

                        const savedAttendance = localStorage.getItem('attendanceProgress');
                        if (savedAttendance) {
                            attendanceProgress.value = JSON.parse(savedAttendance);
                        }

                        const savedDarkMode = localStorage.getItem('darkMode');
                        if (savedDarkMode !== null) {
                            darkMode.value = savedDarkMode === 'true';
                            if (darkMode.value) {
                                document.documentElement.classList.add('dark');
                            }
                        }
                    } catch (error) {
                        console.error('Error loading from storage:', error);
                    }
                };

                const saveToStorage = () => {
                    try {
                        localStorage.setItem('musyrifList', JSON.stringify(musyrifList.value));
                        localStorage.setItem('santriList', JSON.stringify(santriList.value));
                        localStorage.setItem('tahfizhProgress', JSON.stringify(tahfizhProgress.value));
                        localStorage.setItem('ibadahProgress', JSON.stringify(ibadahProgress.value));
                        localStorage.setItem('attendanceProgress', JSON.stringify(attendanceProgress.value));
                        localStorage.setItem('darkMode', darkMode.value.toString());
                    } catch (error) {
                        console.error('Error saving to storage:', error);
                    }
                };

                const autoSave = async () => {
                    autoSaving.value = true;
                    saveToStorage();
                    
                    // Also sync to Supabase if connected
                    if (connectionStatus.value === 'connected') {
                        await syncToSupabase();
                    }
                    
                    setTimeout(() => {
                        autoSaving.value = false;
                    }, 1000);
                };

                // Watchers
                watch(mySantri, () => {
                    if (isMusyrif.value) {
                        initializeTahfizhInput();
                        initializeIbadahInput();
                        initializeAttendanceInput();
                    }
                }, { immediate: true });

                // Watch selected date untuk update attendance input
                watch(selectedDate, () => {
                    if (isMusyrif.value && activeTab.value === 'attendance-input') {
                        initializeAttendanceInput();
                    }
                });

                // Watch connection status
                watch(connectionStatus, (newStatus) => {
                    if (newStatus === 'connected') {
                        setupRealtimeSubscriptions();
                        syncFromSupabase();
                    }
                });

                // Lifecycle
                onMounted(async () => {
                    // Load database config
                    const hasConfig = loadDbConfig();
                    
                    // Load data from localStorage first
                    loadFromStorage();
                    
                    // Try to connect to Supabase if config exists
                    if (hasConfig) {
                        const initialized = initializeSupabase();
                        if (initialized) {
                            const connected = await testConnection();
                            if (connected) {
                                setupRealtimeSubscriptions();
                                await syncFromSupabase();
                            }
                        }
                    }
                    
                    // Auto-save interval
                    setInterval(() => {
                        if (isLoggedIn.value || isPublicAccess.value) {
                            autoSave();
                        }
                    }, 30000);
                    
                    setTimeout(() => {
                        loading.value = false;
                    }, 1500);
                });

                return {
                    // Core state
                    loading,
                    isLoggedIn,
                    isAdmin,
                    isMusyrif,
                    isPublicAccess,
                    currentUser,
                    activeTab,
                    darkMode,
                    autoSaving,
                    isSubmitting,
                    isLoggingIn,
                    loginError,
                    selectedDate,
                    
                    // Supabase state
                    connectionStatus,
                    connectionStatusClass,
                    connectionStatusIcon,
                    connectionStatusText,
                    showConfigModal,
                    isConnecting,
                    dbConfig,
                    
                    // UI state
                    showSantriModal,
                    showMusyrifModal,
                    editingSantri,
                    editingMusyrif,
                    
                    // Forms
                    credentials,
                    santriForm,
                    musyrifForm,
                    santriFilter,
                    tahfizhFilter,
                    ibadahFilter,
                    attendanceFilter,
                    
                    // Data
                    musyrifList,
                    santriList,
                    ibadahList,
                    juzMapping,
                    halaqahList,
                    attendanceStatusOptions,
                    notifications,
                    tahfizhInput,
                    ibadahInput,
                    attendanceInput,
                    
                    // Computed
                    totalSantri,
                    totalMusyrif,
                    averageProgress,
                    todayIbadahCompletion,
                    todayAttendancePercentage,
                    availableMonths,
                    mySantri,
                    uniqueAngkatanList,
                    filteredSantri,
                    filteredSantriForRecap,
                    filteredSantriForIbadah,
                    filteredSantriForAttendance,
                    isSantriFormValid,
                    isMusyrifFormValid,
                    
                    // Methods
                    getCurrentDate,
                    getCurrentMonth,
                    getCurrentDateString,
                    formatDate,
                    formatDateShort,
                    formatDayName,
                    getAvailableMonths,
                    getDaysInMonth,
                    getDateRange,
                    getJuzFromPages,
                    navigateDate,
                    resetToToday,
                    toggleDarkMode,
                    showNotification,
                    removeNotification,
                    getNotificationClass,
                    getNotificationIcon,
                    
                    // Database methods
                    openConfigModal,
                    closeConfigModal,
                    saveDbConfig,
                    
                    // Auth methods
                    login,
                    logout,
                    accessPublic,
                    backToLogin,
                    
                    // Santri management
                    openSantriModal,
                    closeSantriModal,
                    saveSantri,
                    editSantri,
                    deleteSantri,
                    
                    // Musyrif management
                    openMusyrifModal,
                    closeMusyrifModal,
                    saveMusyrif,
                    editMusyrif,
                    deleteMusyrif,
                    
                    // Helper functions
                    getMusyrifName,
                    getSantriByMusyrif,
                    getAngkatanCount,
                    getAngkatanAverageProgressJuz,
                    getAngkatanAverageProgressPercentage,
                    getSantriProgressPage,
                    getSantriCurrentJuz,
                    getSantriProgressPercentage,
                    getMonthlySetoranPages,
                    getMonthlyMurojaahTotal,
                    getMonthlyExamCount,
                    getLatestExam,
                    canSaveTahfizh,
                    saveTahfizhProgress,
                    getTodayTahfizhProgress,
                    toggleIbadah,
                    saveIbadahProgress,
                    saveIbadahForDate,
                    getTodayIbadahCompletion,
                    getIbadahCompletion,
                    getCompletedIbadahCount,
                    isIbadahCompleted,
                    getIbadahSummary,
                    getMonthlyIbadahAverage,
                    getMonthlyIbadahDetailBySantri,
                    showIbadahMonthlyDetail,
                    getMonthlyIbadahSummary,
                    openIbadahDetail,
                    
                    // Attendance methods
                    saveAttendance,
                    getAttendanceStatus,
                    getAttendanceStatusText,
                    getDailyAttendancePercentage,
                    getMonthlyAttendanceAverage,
                    getMonthlyAttendancePercentage,
                    getMonthlyAttendanceSummary
                };
            }
        });

        app.mount('#app');
    </script>
</body>
</html>
